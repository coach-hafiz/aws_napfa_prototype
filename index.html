<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>AprilTag Lap Counter (Fast, Mobile)</title>
  <style>
    :root { --accent:#015871; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7f7f7;color:#111}
    .controls{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e6e6e6;padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .controls button{height:48px;min-width:110px;font-size:16px;font-weight:600;border:0;border-radius:12px;color:#fff;background:var(--accent)}
    .controls button.secondary{background:#666}
    .controls input{height:48px;font-size:16px;padding:0 12px;border:1px solid #ccc;border-radius:12px;width:110px}
    .timer{font-variant-numeric:tabular-nums;font-weight:700;min-width:88px}
    .stage{position:relative;width:100%;max-width:100%;background:#000;overflow:hidden}
    video,canvas{display:block;width:100%;height:auto}
    #overlay{position:absolute;left:0;top:0;pointer-events:none}
    .panel{padding:12px}
    .tableWrap{max-height:45vh;overflow:auto;background:#fff;border:1px solid #eee;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;z-index:1;background:var(--accent);color:#fff;font-weight:700}
    th,td{padding:10px;text-align:center;border-bottom:1px solid #f0f0f0}
    tr.done{background:#e9f6ec}
    .log{font-size:12px;color:#555;margin-top:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="secondary">Stop</button>
    <div class="timer" id="timer">00:00</div>
    <label for="req">Required Laps</label>
    <input id="req" type="number" value="4" min="1" max="50" inputmode="numeric"/>
  </div>

  <div class="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div class="panel">
    <div class="tableWrap">
      <table>
        <thead><tr><th>Tag ID</th><th>Laps</th><th>Finish</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="log" id="log"></div>
  </div>

  <!-- Load two popular AprilTag browser builds (either can succeed). -->
  <!-- Build A: AprilTag WASM (UMD global often named AprilTag/createAprilTagDetector) -->
  <script defer src="https://unpkg.com/apriltag-wasm@0.1.6/dist/apriltag.min.js"></script>
  <!-- Build B: apriltag-js (UMD global often named apriltag) -->
  <script defer src="https://unpkg.com/apriltag-js@0.1.4/dist/apriltag.min.js"></script>

  <script>
  // ---------- DOM ----------
  const video   = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx     = overlay.getContext('2d');
  const tbody   = document.getElementById('tbody');
  const timerEl = document.getElementById('timer');
  const reqEl   = document.getElementById('req');
  const logEl   = document.getElementById('log');

  // ---------- State ----------
  let streaming=false, counting=false, startTime=0, timerInt=null;
  const COOLDOWN_MS=2000;
  const runners={}; // id -> {laps, done, last, finish}
  let guideY=0;

  // AprilTag detector adapter (one of the two libs)
  let detector=null;
  let detectFn=null; // (imageData,width,height) => [{id, cx, cy}]

  // ---------- Utils ----------
  const log=(...a)=>{ console.log(...a); logEl.textContent = [logEl.textContent, a.join(' ')].filter(Boolean).join('\n').slice(-2000); };
  function fitCanvas(){
    if(!video.videoWidth||!video.videoHeight) return;
    overlay.width  = video.videoWidth;
    overlay.height = video.videoHeight;
    guideY = Math.round(overlay.height*0.7);
  }
  function drawGuide(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    // Live frame under canvas:
    ctx.drawImage(video, 0, 0, overlay.width, overlay.height);
    // Guide line:
    ctx.strokeStyle='red';
    ctx.lineWidth = Math.max(3, overlay.height/240);
    ctx.beginPath();
    ctx.moveTo(0, guideY);
    ctx.lineTo(overlay.width, guideY);
    ctx.stroke();
  }
  function ensureRow(id){
    if(runners[id]) return;
    runners[id] = {laps:0, done:false, last:0, finish:'-'};
    const tr = document.createElement('tr');
    tr.id = `r-${id}`;
    tr.innerHTML = `<td>${id}</td><td id="laps-${id}">0</td><td id="fin-${id}">-</td>`;
    tbody.appendChild(tr);
  }
  function updateRow(id){
    document.getElementById(`laps-${id}`).textContent = String(runners[id].laps);
    document.getElementById(`fin-${id}`).textContent  = runners[id].finish;
  }
  function markDone(id){
    document.getElementById(`r-${id}`)?.classList.add('done');
  }
  function hmsSince(ms0){
    const s = Math.floor((Date.now()-ms0)/1000);
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${mm}:${ss}`;
  }

  // ---------- Lap logic ----------
  function countLap(id){
    const now = Date.now();
    const r = runners[id];
    const req = parseInt(reqEl.value||'4',10);
    if(r.done) return;
    if(now - r.last < COOLDOWN_MS) return; // cooldown
    r.laps++; r.last = now;
    if(r.laps >= req){
      r.done = true;
      r.finish = hmsSince(startTime);
      markDone(id);
    }
    updateRow(id);
  }

  // ---------- Camera ----------
  async function initCamera(){
    const constraints = {
      audio:false,
      video:{
        facingMode:{ ideal:'environment' },
        width:{ ideal:1280 },
        height:{ ideal:720 }
      }
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    await new Promise(r=>video.onloadedmetadata=r);
    streaming = true;
    fitCanvas();
    drawGuide();
    log('Camera ready:', video.videoWidth+'x'+video.videoHeight);
  }

  // ---------- AprilTag detector loaders (two API shapes) ----------
  async function tryInitDetector(){
    // Try Build A (apriltag-wasm global): createAprilTagDetector() or AprilTag()
    if (typeof window.createAprilTagDetector === 'function' || typeof window.AprilTag === 'function') {
      try {
        log('Trying detector: apriltag-wasm');
        // Some builds expose createAprilTagDetector, others expose AprilTag() promise
        let mod;
        if (typeof window.createAprilTagDetector === 'function') {
          mod = await window.createAprilTagDetector();
        } else {
          mod = await window.AprilTag(); // returns Module with AprilTagDetector
        }
        // Common API in wasm builds:
        const TagDetector = mod.AprilTagDetector || mod.default || mod;
        const d = new TagDetector();
        if (d.addTagFamily) d.addTagFamily('tag36h11'); // ensure correct family
        detector = d;

        // Build detect adapter: returns [{id,cx,cy}, ...]
        detectFn = (imageData,w,h)=>{
          // Many builds expect grayscale Uint8Array; we’ll downsample fast:
          const gray = new Uint8Array(w*h);
          const data = imageData.data;
          for(let i=0,j=0;i<data.length;i+=4,j++){
            // luma approx
            gray[j] = (data[i]*0.2126 + data[i+1]*0.7152 + data[i+2]*0.0722)|0;
          }
          const tags = detector.detect(gray, w, h); // array of detections
          return (tags||[]).map(t=>{
            const corners = t.corners || t.c || [];
            let cy=0,cx=0;
            for(let k=0;k<corners.length;k++){ cx+=corners[k].x; cy+=corners[k].y; }
            const n = Math.max(1, corners.length);
            return { id: t.id ?? t.tagId ?? t.idNumber ?? -1, cx: cx/n, cy: cy/n };
          });
        };
        log('Loaded apriltag-wasm detector.');
        return true;
      } catch(e) {
        log('apriltag-wasm init error:', e.message||e);
      }
    }

    // Try Build B (apriltag-js global): window.apriltag.Detector
    if (window.apriltag && typeof window.apriltag.Detector === 'function') {
      try {
        log('Trying detector: apriltag-js (UMD)');
        detector = new window.apriltag.Detector({ families: ['tag36h11'] });
        detectFn = (imageData,w,h)=>{
          // apriltag-js expects {data, width, height}
          const detections = detector.detect(imageData);
          return (detections||[]).map(d=>{
            const cs = d.corners||d.c||[];
            let cx=0,cy=0;
            for(let k=0;k<cs.length;k++){ cx+=cs[k].x; cy+=cs[k].y; }
            const n = Math.max(1, cs.length);
            return { id: d.id ?? d.tag_id ?? -1, cx: cx/n, cy: cy/n };
          });
        };
        log('Loaded apriltag-js detector.');
        return true;
      } catch(e) {
        log('apriltag-js init error:', e.message||e);
      }
    }

    return false;
  }

  // ---------- Loop ----------
  function loop(){
    if(!streaming){ requestAnimationFrame(loop); return; }
    drawGuide();

    if(detector && detectFn){
      // Fast: use the canvas frame directly
      const frame = ctx.getImageData(0,0,overlay.width,overlay.height);
      let dets=[];
      try { dets = detectFn(frame, overlay.width, overlay.height) || []; }
      catch(e){ log('Detect error:', e.message||e); }

      if(dets.length){
        // Draw quick boxes/centers
        ctx.save();
        ctx.strokeStyle='lime'; ctx.lineWidth=Math.max(2, overlay.height/360);
        ctx.fillStyle='rgba(0,128,0,0.25)';
        dets.forEach(d=>{
          // Display dot at center for speed
          ctx.beginPath(); ctx.arc(d.cx, d.cy, Math.max(4, overlay.height/200), 0, Math.PI*2); ctx.fill();
          ensureRow(d.id);
          if (counting && Math.abs(d.cy - guideY) < Math.max(16, overlay.height/60)) {
            countLap(d.id);
          }
        });
        ctx.restore();
      }
    }
    requestAnimationFrame(loop);
  }

  // ---------- Timer ----------
  function startTimer(){ startTime=Date.now(); timerEl.textContent='00:00'; timerInt=setInterval(()=>{ timerEl.textContent=hmsSince(startTime); }, 1000); }
  function stopTimer(){ clearInterval(timerInt); timerInt=null; }

  // ---------- Init ----------
  (async function init(){
    try{
      await initCamera();
      await new Promise(r=>setTimeout(r, 50)); // tiny settle
      fitCanvas(); drawGuide();
      const ok = await tryInitDetector();
      if(!ok){
        log('❌ Could not initialize AprilTag detector from CDN builds.');
        log('Tips:');
        log('- Ensure you are serving over HTTPS (Vercel is OK).');
        log('- Try reloading once; some mobile WASM builds need a warm cache.');
        log('- Print large tag36h11 (A6/A5), good light, 1–2m from camera.');
      } else {
        log('✅ Detector ready. Aim tags at the red line.');
      }
      requestAnimationFrame(loop);
    }catch(e){
      log('Init error:', e.message||e);
      alert('Init error: '+ (e.message||e));
    }
  })();

  // ---------- Buttons ----------
  document.getElementById('startBtn').addEventListener('click', ()=>{
    if(counting) return;
    counting=true; startTimer();
  });
  document.getElementById('stopBtn').addEventListener('click', ()=>{
    counting=false; stopTimer();
  });

  // ---------- Resize/orientation handling ----------
  window.addEventListener('resize', ()=>{ fitCanvas(); });
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ fitCanvas(); }, 300); });
  </script>
</body>
</html>
