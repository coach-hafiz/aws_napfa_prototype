<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>TopCodes Lap Counter — Landscape</title>

<style>
  :root {
    --accent:#015871;
    --bg:#f7f7f7;
    --line:red;
  }
  *{ box-sizing:border-box; margin:0; padding:0; }

  body {
    background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow:hidden;
  }

  /* Full-screen rotate warning */
  #rotateNotice {
    position:fixed;
    inset:0;
    background:#000;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-size:24px;
    z-index:9999;
    padding:20px;
  }

  /* LANDSCAPE APP LAYOUT */
  #app {
    display:none; /* shown only in landscape */
    width:100vw;
    height:100vh;
    overflow:hidden;
    background:#000;
    display:flex;
  }

  #leftCam {
    position:relative;
    width:55vw;
    height:100vh;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* Keep aspect ratio, avoid stretching and zoomy feel */
  #view {
    width:100%;
    height:auto;
    max-height:100vh;
    display:block;
    background:#000;
  }

  #rightUI {
    width:45vw;
    height:100vh;
    background:#fff;
    display:flex;
    flex-direction:column;
    padding:10px;
    overflow:hidden;
  }

  .controls {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:10px;
  }
  button {
    background:var(--accent);
    color:#fff;
    border:0;
    padding:10px 14px;
    border-radius:8px;
    font-weight:700;
    font-size:14px;
    cursor:pointer;
  }
  button.secondary { background:#666 }
  button:disabled { opacity:0.4; cursor:default; }

  select {
    height:38px;
    padding:0 10px;
    border:1px solid #ccc;
    border-radius:8px;
    font-weight:600;
    font-size:13px;
  }

  .timer {
    font-weight:700;
    font-size:18px;
    min-width:80px;
    text-align:center;
    font-variant-numeric:tabular-nums;
  }

  #status {
    padding:8px;
    margin-bottom:10px;
    background:#eef;
    border-radius:8px;
    font-size:13px;
  }

  #tableWrap {
    flex:1;
    overflow:auto;
    border:1px solid #ddd;
    border-radius:8px;
    background:#fff;
  }

  table {
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th {
    background:var(--accent);
    color:#fff;
    position:sticky;
    top:0;
    padding:8px;
  }
  td {
    padding:6px;
    border-bottom:1px solid #eee;
    text-align:center;
  }
  tr.done { background:#e0f7e0; }

  .label {
    font-size:13px;
    margin-left:4px;
  }

  /* Responsive tweaks: phones / small tablets in landscape */
  @media (max-width: 900px) {
    .controls {
      gap:6px;
    }
    button {
      font-size:12px;
      padding:8px 10px;
    }
    select {
      height:34px;
      font-size:12px;
    }
    .timer {
      font-size:16px;
      min-width:72px;
    }
    #status {
      font-size:12px;
    }
    th, td {
      font-size:12px;
      padding:5px;
    }
  }

  /* Larger tablets / desktops */
  @media (min-width: 1280px) {
    button {
      font-size:15px;
      padding:10px 16px;
    }
    select {
      font-size:14px;
    }
    .timer {
      font-size:20px;
    }
  }
</style>
</head>

<body>

<div id="rotateNotice">Please rotate your device to <strong>LANDSCAPE</strong> to begin.</div>

<div id="app">
  <div id="leftCam">
    <!-- 16:9 internal resolution for better aspect; still light -->
    <canvas id="view" width="640" height="360"></canvas>
  </div>

  <div id="rightUI">

    <div class="controls">
      <button id="enableBtn">Enable Camera</button>
      <button id="startBtn" class="secondary" disabled>Start</button>
      <button id="stopBtn"  class="secondary" disabled>Stop</button>
      <div class="timer" id="timer">00:00</div>

      <span class="label">Laps</span>
      <select id="lapsSel"></select>

      <span class="label">Camera</span>
      <select id="camSel">
        <option value="environment" selected>Rear</option>
        <option value="user">Front</option>
      </select>

      <button id="exportBtn" class="secondary" disabled>Export CSV</button>
    </div>

    <div id="status">Waiting.</div>

    <div id="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Runner</th>
            <th>Laps</th>
            <th>Finish</th>
            <th>Splits</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- Global camera patch: respect selected front/rear on all getUserMedia calls -->
<script>
(function(){
  // default to rear
  window._desiredFacing = "environment";

  function applyFacing(constraints){
    constraints = constraints || {};
    if (constraints.video === true) constraints.video = {};
    if (typeof constraints.video === "object"){
      const facing = window._desiredFacing || "environment";
      constraints.video.facingMode = { ideal:facing };
      constraints.video.width  = constraints.video.width  || { ideal: 640 };
      constraints.video.height = constraints.video.height || { ideal: 360 };
    }
    return constraints;
  }

  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    const orig = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
    navigator.mediaDevices.getUserMedia = function(c){
      return orig(applyFacing(c));
    };
  }

  const legacy = navigator.getUserMedia;
  if (legacy){
    navigator.getUserMedia = function(c,s,e){
      return legacy.call(navigator, applyFacing(c), s, e);
    };
  }

  const wk = navigator.webkitGetUserMedia;
  if (wk){
    navigator.webkitGetUserMedia = function(c,s,e){
      return wk.call(navigator, applyFacing(c), s, e);
    };
  }

  const moz = navigator.mozGetUserMedia;
  if (moz){
    navigator.mozGetUserMedia = function(c,s,e){
      return moz.call(navigator, applyFacing(c), s, e);
    };
  }
})();
</script>

<!-- TopCodes library -->
<script src="https://cdn.jsdelivr.net/gh/TIDAL-Lab/TopCodes@master/javascript/topcodes.js"></script>

<script>
(function(){

/* LANDSCAPE-ONLY MODE */
function checkOrientation(){
  const isLandscape = window.matchMedia("(orientation: landscape)").matches;
  document.getElementById("rotateNotice").style.display = isLandscape ? "none" : "flex";
  document.getElementById("app").style.display = isLandscape ? "flex" : "none";
}
window.addEventListener("orientationchange", checkOrientation);
window.addEventListener("resize", checkOrientation);
checkOrientation();

/* iOS detection (for disabling video recording) */
const isIOS = /iP(hone|od|ad)/.test(navigator.userAgent);

/* TopCode → Runner ID mapping */
const MAP = {
  31:1,47:2,55:3,59:4,61:5,
  79:6,87:7,91:8,93:9,103:10,
  107:11,109:12,115:13,117:14,121:15,
  143:16,151:17,155:18,157:19,167:20
};
function mapID(raw){ return MAP.hasOwnProperty(raw) ? MAP[raw] : null; }

/* DOM */
const canvas   = document.getElementById("view");
const ctx      = canvas.getContext("2d",{ willReadFrequently:true });
const statusEl = document.getElementById("status");
const tbody    = document.getElementById("tbody");
const timerEl  = document.getElementById("timer");
const enableBtn= document.getElementById("enableBtn");
const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const exportBtn= document.getElementById("exportBtn");
const lapsSel  = document.getElementById("lapsSel");
const camSel   = document.getElementById("camSel");

/* Populate laps 1–20 */
for(let i=1;i<=20;i++){
  const o=document.createElement("option");
  o.value=i; o.textContent=i;
  if(i===4) o.selected=true;
  lapsSel.appendChild(o);
}

/* State */
let cameraEnabled=false;
let counting=false;
let startTime=0;
let timerHandle=null;
let recorder=null;   // used only on non-iOS
let chunks=[];
const runners=new Map();
const COOLDOWN=1200;

/* Helpers */
function setStatus(msg){
  statusEl.textContent = msg;
  console.log(msg);
}

function mmss(ms){
  const s=Math.floor(ms/1000);
  return String(Math.floor(s/60)).padStart(2,"0")
       +":"+String(s%60).padStart(2,"0");
}

function ensureRunner(id){
  if(runners.has(id)) return;
  runners.set(id,{laps:[],last:0,finished:false});
  const tr=document.createElement("tr");
  tr.id="r-"+id;
  tr.innerHTML=`
    <td>${id}</td>
    <td id="laps-${id}">0</td>
    <td id="fin-${id}">-</td>
    <td id="splits-${id}">-</td>`;
  tbody.appendChild(tr);
}

function updateRow(id){
  const r=runners.get(id);
  const laps=r.laps.length;
  document.getElementById("laps-"+id).textContent=laps;
  document.getElementById("fin-"+id).textContent =
    laps ? mmss(r.laps[laps-1]) : "–";
  document.getElementById("splits-"+id).textContent =
    laps ? r.laps.map(mmss).join(" | ") : "–";
  if(r.finished) document.getElementById("r-"+id).classList.add("done");
}

/* Timer */
function startTimer(){
  startTime=Date.now();
  timerHandle=setInterval(()=>{
    timerEl.textContent = mmss(Date.now()-startTime);
  },1000);
}
function stopTimer(){
  clearInterval(timerHandle);
  timerHandle=null;
}

/* Recording (disabled on iOS to avoid WebKit blob errors) */
function startRecording(){
  if(isIOS) return; // skip recording on iOS
  chunks=[];
  const stream = canvas.captureStream ? canvas.captureStream(20) : null;
  if(!stream){ return; }
  try{
    recorder = new MediaRecorder(stream,{mimeType:"video/webm"});
  }catch(e){
    recorder=null; return;
  }
  recorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
  recorder.onstop = () => {
    if(!chunks.length) return;
    const blob=new Blob(chunks,{type:"video/webm"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="run_"+Date.now()+".webm";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };
  recorder.start();
}
function stopRecording(){
  if(isIOS) return;
  try{
    if(recorder && recorder.state!=="inactive") recorder.stop();
  }catch(e){}
}

/* TopCodes frame callback */
let frameSkip=0;
function handleFrame(json){
  frameSkip++;
  if(frameSkip % 2 !== 0) return; // throttle for speed

  let data;
  try{ data=JSON.parse(json); }catch(e){ return; }

  const codes=data.topcodes || [];
  const lineY = Math.floor(canvas.height*0.5);

  // DO NOT clear the whole canvas, to avoid flickering the video.
  // Just draw the line on top.
  ctx.save();
  ctx.strokeStyle="red";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(0,lineY);
  ctx.lineTo(canvas.width,lineY);
  ctx.stroke();
  ctx.restore();

  if(!counting) return;

  const now=Date.now();
  const threshold = canvas.height/7;

  for(const tc of codes){
    const id=mapID(tc.code);
    if(!id) continue;
    if(Math.abs(tc.y - lineY) <= threshold){
      ensureRunner(id);
      const r=runners.get(id);
      if(now - r.last >= COOLDOWN){
        r.laps.push(now - startTime);
        r.last = now;
        if(r.laps.length >= parseInt(lapsSel.value,10)){
          r.finished = true;
        }
        updateRow(id);
      }
    }
  }
}

/* Camera selector: update global facing preference.
   User must re-tap "Enable Camera" after changing. */
camSel.addEventListener("change", () => {
  window._desiredFacing = camSel.value;  // "user" or "environment"
  setStatus("Camera preference set to: " + camSel.value +
            ". Tap 'Enable Camera' to apply.");
});

/* Buttons */
enableBtn.addEventListener("click",()=>{
  try{
    TopCodes.startStopVideoScan("view");
    TopCodes.setVideoFrameCallback("view", handleFrame);
    cameraEnabled=true;
    enableBtn.disabled=true;
    startBtn.disabled=false;
    setStatus("Camera enabled ("+camSel.value+").");
  }catch(e){
    console.error(e);
    setStatus("Camera error: "+(e.message||e));
    enableBtn.disabled=false;
  }
});

startBtn.addEventListener("click",()=>{
  if(!cameraEnabled){
    setStatus("Enable camera first.");
    return;
  }
  runners.clear();
  tbody.innerHTML="";
  counting=true;
  startBtn.disabled=true;
  stopBtn.disabled=false;
  exportBtn.disabled=true;
  startTimer();
  startRecording();
  setStatus("Counting…");
});

stopBtn.addEventListener("click",()=>{
  if(!counting) return;
  counting=false;
  stopTimer();
  stopRecording();
  for(const [id,r] of runners){
    if(!r.finished){
      const fin=document.getElementById("fin-"+id);
      if(fin) fin.textContent="DNF";
    }
  }
  startBtn.disabled=false;
  stopBtn.disabled=true;
  exportBtn.disabled=false;
  setStatus("Stopped.");
});

/* CSV EXPORT – data URL (no Blob) */
exportBtn.addEventListener("click",()=>{
  if(!runners.size){
    setStatus("No data to export.");
    return;
  }

  let maxL=0;
  for(const r of runners.values()){
    if(r.laps.length>maxL) maxL=r.laps.length;
  }

  const rows=[];
  const header=["Runner","Total Laps","Finish"];
  for(let i=1;i<=maxL;i++) header.push("Lap "+i);
  rows.push(header);

  for(const [id,r] of runners){
    const total=r.laps.length;
    const finish= total? mmss(r.laps[total-1]):"DNF";
    const row=[id,String(total),finish];
    for(let i=0;i<maxL;i++){
      row.push(r.laps[i]? mmss(r.laps[i]):"");
    }
    rows.push(row);
  }

  const csv=rows.map(r=>r.join(",")).join("\n");
  const encoded = encodeURIComponent(csv);
  const href = "data:text/csv;charset=utf-8," + encoded;

  const a=document.createElement("a");
  a.href=href;
  a.download="laps_"+Date.now()+".csv";
  document.body.appendChild(a);
  a.click();
  a.remove();

  setStatus("CSV exported.");
});

/* Initial status */
setStatus("Waiting. Choose camera, then tap 'Enable Camera'.");

})();
</script>

</body>
</html>