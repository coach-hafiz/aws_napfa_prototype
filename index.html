<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>AprilTag Lap Counter</title>
<style>
  :root{ --accent:#036; --bg:#fafafa }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:#111 }
  header{ display:flex; gap:8px; padding:12px; align-items:center; background:#fff; border-bottom:1px solid #e6e6e6; position:sticky; top:0; z-index:10 }
  button{ background:var(--accent); color:#fff; border:0; padding:10px 12px; border-radius:10px; font-weight:700 }
  button.secondary{ background:#666 }
  select,input[type=number]{ padding:8px; border-radius:8px; border:1px solid #ddd }
  .timer{ font-weight:700; min-width:72px; text-align:center }
  .container{ max-width:1100px; margin:12px auto; padding:0 12px }
  .video-wrap{ background:#000; border-radius:10px; overflow:hidden }
  canvas#view{ display:block; width:100%; height:auto; touch-action:none }
  .panel{ margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start }
  .tbl{ flex:1; min-width:300px; background:#fff; border-radius:10px; border:1px solid #eee; max-height:44vh; overflow:auto }
  table{ width:100%; border-collapse:collapse }
  thead th{ background:var(--accent); color:#fff; padding:8px; position:sticky; top:0; text-align:center }
  td,th{ padding:8px; text-align:center; border-bottom:1px solid #f3f3f3; font-size:14px }
  tr.done{ background:#e9f6ec }
  .log{ white-space:pre-wrap; font-size:13px; color:#333; margin-top:8px }
  .muted{ color:#666; font-size:13px }
  @media (max-width:640px){ header{ flex-wrap:wrap } }
</style>
</head>
<body>
  <header>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="startBtn">Start</button>
      <button id="stopBtn" class="secondary" disabled>Stop</button>
      <button id="exportBtn" class="secondary" disabled>Export CSV</button>
    </div>

    <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
      <label class="muted">Laps</label>
      <select id="lapsSelect">
        <!-- options will be inserted by script -->
      </select>

      <div class="timer" id="timer">00:00</div>
    </div>
  </header>

  <div class="container">
    <div class="video-wrap">
      <canvas id="view"></canvas>
    </div>

    <div class="panel">
      <div class="tbl">
        <table>
          <thead><tr><th>Tag ID</th><th>Laps</th><th>Finish</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div style="width:260px">
        <div class="muted">Status</div>
        <div id="status" class="log">Idle. Click Start to allow camera and begin.</div>
        <div style="margin-top:12px;" class="muted">Notes</div>
        <div class="log muted">Point your camera to the track, place the red line at the crossing height (calibrate by resizing device or page). The app detects AprilTag IDs and counts a lap when a tag crosses the red line.</div>
      </div>
    </div>
  </div>

  <!-- AprilTag JS (WASM) -->
  <script defer src="https://unpkg.com/apriltag-js@0.1.4/dist/apriltag.min.js"></script>

  <script>
  // Simple, self-contained AprilTag lap counter
  // Features:
  // - camera capture + apriltag-js detections
  // - red guide line (start/finish)
  // - laps dropdown
  // - Start / Stop
  // - Export CSV after Stop
  // - Auto-DNF on Stop for incomplete runners
  // - Table: Tag ID, laps completed, finish time

  // --- DOM ---
  const canvas = document.getElementById('view');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const tbody = document.getElementById('tbody');
  const statusEl = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const exportBtn = document.getElementById('exportBtn');
  const lapsSelect = document.getElementById('lapsSelect');

  // --- state ---
  let stream = null, video = null;
  let w = 1280,
