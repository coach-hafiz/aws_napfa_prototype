<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>QR / Barcode Lap Counter — Responsive</title>
<style>
:root{
  --accent:#015871;
  --bg:#f7f7f7;
  --line:red;
}
*{ box-sizing:border-box }
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:#111;
}

/* App grid switches by orientation */
.app{ display:grid; min-height:100vh; }

/* Portrait: top quarter (25vh) for video+controls; bottom for table */
@media (orientation:portrait){
  .app{
    grid-template-rows: 25vh 1fr;
    grid-template-columns: 1fr;
    grid-template-areas:
      "top"
      "bottom";
  }
  .top{ grid-area: top; }
  .bottom{ grid-area: bottom; }
}

/* Landscape: left half for video+controls; right half for table */
@media (orientation:landscape){
  .app{
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 100vh;
    grid-template-areas:
      "left right";
  }
  .top{ grid-area: left; height:100vh; }
  .bottom{ grid-area: right; height:100vh; }
}

/* Video+controls container */
.top{
  position:relative;
  background:#000;
  overflow:hidden;
}

/* We render video + overlays into ONE canvas */
#view{
  width:100%;
  height:100%;
  display:block;
  background:#000;
  touch-action:none;
}

/* Controls overlay: always visible */
.controls{
  position:absolute;
  left:0; right:0; top:0;
  z-index:20;
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  padding:8px;
  background:linear-gradient(
    180deg,
    rgba(255,255,255,0.95) 0%,
    rgba(255,255,255,0.80) 90%,
    rgba(255,255,255,0) 100%
  );
  border-bottom:1px solid rgba(0,0,0,0.06);
}

button{
  background:var(--accent);
  color:#fff;
  border:0;
  border-radius:10px;
  font-weight:700;
  padding:10px 12px;
  cursor:pointer;
}
button.secondary{ background:#666 }
button:disabled{ opacity:0.5; cursor:default }

select{
  height:42px;
  padding:0 10px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#fff;
  font-weight:600;
}

.timer{
  font-variant-numeric:tabular-nums;
  font-weight:700;
  min-width:78px;
}
.spacer{ flex:1 1 auto }

/* Bottom pane: table + status */
.bottom{
  display:grid;
  grid-template-rows: auto 1fr auto;
  gap:8px;
  padding:10px;
  min-height:0; /* allow child scrolling */
}

.status{
  font-size:13px;
  color:#333;
  white-space:pre-wrap;
  background:#fff;
  border:1px solid #eee;
  border-radius:10px;
  padding:8px;
}

.tableWrap{
  min-height:0;
  background:#fff;
  border:1px solid #eee;
  border-radius:10px;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
thead th{
  position:sticky;
  top:0;
  background:var(--accent);
  color:#fff;
  padding:8px;
  z-index:1;
}
td,th{
  padding:8px;
  border-bottom:1px solid #f0f0f0;
  text-align:center;
}
tr.done{ background:#e9f6ec }

.footerBar{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  font-size:12px;
  color:#444;
}

/* Small screens: keep buttons readable */
@media (max-width:420px){
  button{ padding:8px 10px }
  .timer{ min-width:66px }
  select{ height:38px }
}
</style>
</head>
<body>
<div class="app">
  <section class="top">
    <canvas id="view" aria-label="Camera view with overlay and start line"></canvas>
    <div class="controls">
      <button id="enableBtn">Enable Camera</button>
      <button id="startBtn" class="secondary" disabled>Start</button>
      <button id="stopBtn"  class="secondary" disabled>Stop</button>
      <div class="timer" id="timer">00:00</div>

      <label for="lapsSel" style="margin-left:6px;font-size:12px;color:#333">Laps</label>
      <select id="lapsSel" aria-label="Number of laps"></select>

      <button id="exportBtn" class="secondary" disabled>Export CSV</button>

      <span class="spacer"></span>

      <span style="font-size:11px;color:#555">
        Aim QR/barcodes so they cross the red line.
      </span>
    </div>
  </section>

  <section class="bottom">
    <div class="status" id="status">Idle. Tap “Enable Camera”.</div>
    <div class="tableWrap">
      <table>
        <thead>
        <tr>
          <th>Runner ID</th>
          <th>Laps Left</th>
          <th>Finish</th>
          <th>Splits (mm:ss, …)</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footerBar">
      • Use clear QR codes (or barcodes encoded as QR) • Good lighting improves scans • Tags can be angled, not perfectly flat
    </div>
  </section>
</div>

<!-- jsQR: pure JS QR reader -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
(function(){
  // ===== DOM =====
  var canvas   = document.getElementById('view');
  var ctx      = canvas.getContext('2d', { willReadFrequently:true });

  var statusEl = document.getElementById('status');
  var tbody    = document.getElementById('tbody');
  var timerEl  = document.getElementById('timer');
  var enableBtn= document.getElementById('enableBtn');
  var startBtn = document.getElementById('startBtn');
  var stopBtn  = document.getElementById('stopBtn');
  var exportBtn= document.getElementById('exportBtn');
  var lapsSel  = document.getElementById('lapsSel');

  // Populate laps 1..20 (default 4)
  for (var i=1;i<=20;i++){
    var opt=document.createElement('option');
    opt.value=i;
    opt.textContent=i;
    if(i===4) opt.selected=true;
    lapsSel.appendChild(opt);
  }

  // ===== State =====
  var stream=null, video=null;
  var cw=640, ch=360;
  var lineY=0;
  var running=false, counting=false, startTime=0, timerTick=null;
  var frameCount=0;
  var COOLDOWN=1200; // ms per runner to prevent double-counts

  // id -> {laps: [ms], lastTs, finished, totalLaps}
  var runners=new Map();

  // ===== Helpers =====
  function setStatus(msg){
    statusEl.textContent = msg;
    console.log(msg);
  }

  function msToMMSS(ms){
    var s = Math.floor(ms/1000);
    var m = Math.floor(s/60);
    var ss= s % 60;
    return String(m).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
  }

  function safeKey(id){
    return String(id).replace(/[^a-zA-Z0-9_-]/g,'_');
  }

  function colorForRemaining(rem){
    if (rem === 20 || rem === 14 || rem === 9 || rem === 4) return '#40E0D0'; // turquoise
    if (rem === 19 || rem === 13 || rem === 8 || rem === 3) return '#4CAF50'; // green
    if (rem === 18 || rem === 12 || rem === 7 || rem === 2) return '#9C27B0'; // purple
    if (rem === 17)                                        return '#CDDC39'; // lime
    if (rem === 16 || rem === 11 || rem === 6)             return '#2196F3'; // blue
    if (rem === 15 || rem === 10 || rem === 5)             return '#FF9800'; // orange
    if (rem === 1)                                         return '#F44336'; // red
    if (rem <= 0)                                          return '#9E9E9E'; // grey
    return '#EEEEEE'; // default
  }

  function ensureRunner(id){
    if (!runners.has(id)){
      var total = parseInt(lapsSel.value,10);
      runners.set(id, { laps:[], lastTs:0, finished:false, totalLaps: total });

      var safe = safeKey(id);
      var tr = document.createElement('tr');
      tr.id = 'r-' + safe;
      tr.innerHTML =
        '<td>'+id+'</td>'+
        '<td id="laps-'+safe+'">'+total+'</td>'+
        '<td id="fin-'+safe+'">-</td>'+
        '<td id="splits-'+safe+'">-</td>';
      tbody.appendChild(tr);
    }
  }

  function updateRunnerRow(id){
    var r = runners.get(id);
    var safe = safeKey(id);
    var lapsDone = r.laps.length;
    var remaining = Math.max(r.totalLaps - lapsDone, 0);

    var lapsCell   = document.getElementById('laps-'+safe);
    var finCell    = document.getElementById('fin-'+safe);
    var splitsCell = document.getElementById('splits-'+safe);

    if (lapsCell){
      lapsCell.textContent = remaining;
      var color = colorForRemaining(remaining);
      lapsCell.style.backgroundColor = color;
      lapsCell.style.color = (remaining <= 1) ? '#fff' : '#000';
    }

    if (finCell){
      finCell.textContent = lapsDone ? msToMMSS(r.laps[lapsDone-1]) : '-';
      if (r.finished && remaining === 0){
        finCell.style.fontWeight = '700';
      }
    }

    if (splitsCell){
      splitsCell.textContent = lapsDone ? r.laps.map(msToMMSS).join(' | ') : '-';
    }

    if (r.finished){
      var row = document.getElementById('r-'+safe);
      if (row) row.classList.add('done');
    }
  }

  function countLap(id){
    var now = Date.now();
    var r   = runners.get(id);

    if (r.finished) return;
    if (now - r.lastTs < COOLDOWN) return;

    r.laps.push(now - startTime);
    r.lastTs = now;

    if (r.laps.length >= r.totalLaps){
      r.finished = true;
    }

    updateRunnerRow(id);

    var remaining = Math.max(r.totalLaps - r.laps.length, 0);
    setStatus('Runner '+id+' → laps left: '+remaining+(r.finished ? ' (Finished)' : ''));
  }

  function startTimer(){
    startTime = Date.now();
    timerEl.textContent = '00:00';
    timerTick = setInterval(function(){
      timerEl.textContent = msToMMSS(Date.now()-startTime);
    }, 1000);
  }

  function stopTimer(){
    if (timerTick){
      clearInterval(timerTick);
      timerTick = null;
    }
  }

  // ===== Camera =====
  async function enableCamera(){
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      setStatus('getUserMedia not supported in this browser.');
      return;
    }
    setStatus('Requesting camera…');
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{
          facingMode:{ ideal:'environment' },
          width:{ ideal:640 },
          height:{ ideal:360 }
        },
        audio:false
      });
    }catch(e){
      setStatus('Camera error: '+(e.message || e));
      return;
    }

    video = document.createElement('video');
    video.srcObject = stream;
    video.playsInline = true;
    video.muted = true;

    try { await video.play(); } catch(e){}

    await new Promise(function(resolve){
      if (video.readyState >= 2) resolve();
      else video.onloadedmetadata = resolve;
    });

    resizeCanvasToLayout();

    enableBtn.disabled = true;
    startBtn.disabled  = false;
    stopBtn.disabled   = true;
    exportBtn.disabled = true;

    running = true;
    requestAnimationFrame(loop);

    setStatus('Camera ready. Aim QR codes at the red line. Tap “Start” to begin.');
  }

  function resizeCanvasToLayout(){
    var rect = canvas.getBoundingClientRect();
    var dpr  = window.devicePixelRatio || 1;
    cw = Math.max(320, Math.floor(rect.width * dpr));
    ch = Math.max(240, Math.floor(rect.height * dpr));
    canvas.width  = cw;
    canvas.height = ch;
    lineY = Math.round(ch * 0.5);
  }
  window.addEventListener('resize', resizeCanvasToLayout);

  function drawVideoCover(){
    if (!video || video.readyState < 2){
      ctx.clearRect(0,0,cw,ch);
      return;
    }
    var vw = video.videoWidth  || 640;
    var vh = video.videoHeight || 360;
    var vr = vw / vh;
    var cr = cw / ch;

    var sx=0, sy=0, sw=vw, sh=vh;
    if (cr > vr){
      sh = Math.round(vw / cr);
      sy = Math.floor((vh - sh) / 2);
    } else {
      sw = Math.round(vh * cr);
      sx = Math.floor((vw - sw) / 2);
    }
    try{
      ctx.drawImage(video, sx,sy,sw,sh, 0,0,cw,ch);
    }catch(e){}
  }

  // ===== Multi-QR detection using jsQR =====
  function detectMultipleQRCodesInBand(maxCodes){
    var bandH = Math.max(Math.floor(ch * 0.4), 120); // 40% height band
    var y0    = Math.max(0, lineY - Math.floor(bandH/2));
    if (y0 + bandH > ch) bandH = ch - y0;

    var imgData = ctx.getImageData(0, y0, cw, bandH);
    var data    = imgData.data;
    var results = [];
    var tries   = 0;

    while (tries < maxCodes){
      var qr = jsQR(data, imgData.width, imgData.height, {
        inversionAttempts: "attemptBoth"
      });
      if (!qr || !qr.data) break;

      results.push({
        data: qr.data,
        location: {
          topLeftCorner: {
            x: qr.location.topLeftCorner.x,
            y: qr.location.topLeftCorner.y + y0
          },
          topRightCorner: {
            x: qr.location.topRightCorner.x,
            y: qr.location.topRightCorner.y + y0
          },
          bottomRightCorner: {
            x: qr.location.bottomRightCorner.x,
            y: qr.location.bottomRightCorner.y + y0
          },
          bottomLeftCorner: {
            x: qr.location.bottomLeftCorner.x,
            y: qr.location.bottomLeftCorner.y + y0
          }
        }
      });

      // Mask out the detected QR so jsQR can find another
      var xs = [
        qr.location.topLeftCorner.x,
        qr.location.topRightCorner.x,
        qr.location.bottomLeftCorner.x,
        qr.location.bottomRightCorner.x
      ];
      var ys = [
        qr.location.topLeftCorner.y,
        qr.location.topRightCorner.y,
        qr.location.bottomLeftCorner.y,
        qr.location.bottomRightCorner.y
      ];
      var minX = Math.max(0, Math.floor(Math.min.apply(null,xs)));
      var maxX = Math.min(imgData.width-1, Math.ceil(Math.max.apply(null,xs)));
      var minY = Math.max(0, Math.floor(Math.min.apply(null,ys)));
      var maxY = Math.min(imgData.height-1, Math.ceil(Math.max.apply(null,ys)));

      for (var y=minY; y<=maxY; y++){
        for (var x=minX; x<=maxX; x++){
          var idx = (y * imgData.width + x) * 4;
          data[idx]   = 255;
          data[idx+1] = 255;
          data[idx+2] = 255;
          data[idx+3] = 255;
        }
      }

      tries++;
    }

    return results;
  }

  // ===== Main loop: draw frame → line → detect QRs =====
  function loop(){
    if (!running) return;

    drawVideoCover();

    // red start line
    ctx.strokeStyle = getComputedStyle(document.documentElement)
      .getPropertyValue('--line').trim() || 'red';
    ctx.lineWidth = Math.max(3, ch/220);
    ctx.beginPath();
    ctx.moveTo(0, lineY);
    ctx.lineTo(cw, lineY);
    ctx.stroke();

    frameCount++;

    if (video && video.readyState >= 2){
      if (frameCount % 2 === 0){ // throttle detection
        var qrs = detectMultipleQRCodesInBand(5); // up to 5 per frame

        var threshold = Math.max(16, ch/10);

        for (var i=0;i<qrs.length;i++){
          var qr = qrs[i];
          var pts = qr.location;
          var cx = (pts.topLeftCorner.x + pts.topRightCorner.x +
                    pts.bottomLeftCorner.x + pts.bottomRightCorner.x) / 4;
          var cy = (pts.topLeftCorner.y + pts.topRightCorner.y +
                    pts.bottomLeftCorner.y + pts.bottomRightCorner.y) / 4;

          // visual feedback
          ctx.save();
          ctx.strokeStyle='lime';
          ctx.lineWidth=Math.max(2, ch/360);
          ctx.beginPath();
          ctx.moveTo(pts.topLeftCorner.x, pts.topLeftCorner.y);
          ctx.lineTo(pts.topRightCorner.x, pts.topRightCorner.y);
          ctx.lineTo(pts.bottomRightCorner.x, pts.bottomRightCorner.y);
          ctx.lineTo(pts.bottomLeftCorner.x, pts.bottomLeftCorner.y);
          ctx.closePath();
          ctx.stroke();

          ctx.fillStyle='rgba(0,255,0,0.25)';
          ctx.beginPath();
          ctx.arc(cx, cy, Math.max(4, ch/200), 0, Math.PI*2);
          ctx.fill();
          ctx.restore();

          // band around line
          if (Math.abs(cy - lineY) <= threshold){
            var id = String(qr.data || '').trim();
            if (!id) continue;
            ensureRunner(id);
            if (counting){
              countLap(id);
            }
          }
        }
      }
    }

    requestAnimationFrame(loop);
  }

  // ===== Buttons =====
  enableBtn.addEventListener('click', function(){
    enableBtn.disabled = true;
    enableCamera();
  });

  startBtn.addEventListener('click', function(){
    if (!stream){
      setStatus('Enable camera first.');
      return;
    }
    if (counting) return;

    runners.clear();
    tbody.innerHTML = '';

    counting = true;
    startTimer();

    startBtn.disabled  = true;
    stopBtn.disabled   = false;
    exportBtn.disabled = true;

    setStatus('Counting… QR codes crossing the line will reduce laps left.');
  });

  stopBtn.addEventListener('click', function(){
    if (!counting) return;
    counting = false;
    stopTimer();

    // Mark unfinished as DNF
    runners.forEach(function(r, id){
      if (!r.finished){
        var safe = safeKey(id);
        var finCell = document.getElementById('fin-'+safe);
        if (finCell) finCell.textContent = 'DNF';
      }
    });

    startBtn.disabled  = false;
    stopBtn.disabled   = true;
    exportBtn.disabled = runners.size === 0;

    setStatus('Stopped. You can export CSV now.');
  });

  exportBtn.addEventListener('click', function(){
    if (!runners.size){
      setStatus('No data to export.');
      return;
    }

    var maxLaps = 0;
    runners.forEach(function(r){
      if (r.laps.length > maxLaps) maxLaps = r.laps.length;
    });

    var rows = [];
    var header = ['Runner ID','Total Laps','Finish'];
    for (var i=1;i<=maxLaps;i++) header.push('Lap '+i);
    rows.push(header);

    runners.forEach(function(r, id){
      var total  = r.totalLaps;
      var lapsDone = r.laps.length;
      var finish = lapsDone ? msToMMSS(r.laps[lapsDone-1]) : 'DNF';
      var row    = [id, String(total), finish];
      for (var j=0;j<maxLaps;j++){
        row.push(r.laps[j] != null ? msToMMSS(r.laps[j]) : '');
      }
      rows.push(row);
    });

    var csv = rows.map(function(r){
      return r.map(function(c){
        var s = String(c);
        return (s.indexOf(',') !== -1)
          ? '"' + s.replace(/"/g,'""') + '"'
          : s;
      }).join(',');
    }).join('\n');

    var encoded = encodeURIComponent(csv);
    var href    = 'data:text/csv;charset=utf-8,' + encoded;
    var a       = document.createElement('a');
    a.href      = href;
    a.download  = 'qr_laps_' + new Date().toISOString().replace(/[:.]/g,'-') + '.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();

    setStatus('CSV exported.');
  });

  // Initial UI
  setStatus('Idle. Tap “Enable Camera”.');

})();
</script>
</body>
</html>