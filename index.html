<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>AprilTag Lap Counter — SVG / Image Upload Tester</title>
<style>
  :root{ --accent:#036; --bg:#fafafa }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:#111 }
  header{ display:flex; gap:8px; padding:12px; align-items:center; background:#fff; border-bottom:1px solid #e6e6e6; position:sticky; top:0; z-index:10; flex-wrap:wrap }
  button{ background:var(--accent); color:#fff; border:0; padding:10px 12px; border-radius:10px; font-weight:700 }
  button.secondary{ background:#666 }
  input,select{ padding:8px; border-radius:8px; border:1px solid #ddd }
  .container{ max-width:1100px; margin:12px auto; padding:0 12px }
  .panel{ margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start }
  .tbl{ flex:1; min-width:300px; background:#fff; border-radius:10px; border:1px solid #eee; max-height:44vh; overflow:auto; padding:8px }
  .results { margin-top:8px; background:#fff; padding:8px; border-radius:8px; border:1px solid #eee; max-height:50vh; overflow:auto }
  .ok{ color:green; font-weight:700 }
  .bad{ color:#b02; font-weight:700 }
  .muted{ color:#666; font-size:13px }
  canvas.preview{ width:160px; height:auto; border:1px solid #ddd; margin-right:8px; }
  .file-row{ display:flex; gap:8px; align-items:center; margin-bottom:8px }
  .file-info{ flex:1 }
  .tag-pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#eef6f8; color:#024047; font-weight:700; margin-left:8px }
</style>
</head>
<body>
  <header>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="fileInput" type="file" accept="image/*,image/svg+xml" multiple />
      <button id="processBtn">Process Images</button>
      <label class="muted" style="margin-left:8px">Raster max dim:</label>
      <input id="maxDim" type="number" value="1200" min="200" style="width:110px" />
    </div>

    <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
      <div class="muted">Filenames should be tag IDs (e.g. 5.svg)</div>
    </div>
  </header>

  <div class="container">
    <div class="muted" style="margin-top:8px">Upload SVG/PNG/JPG files and click "Process Images". The app will rasterize SVGs (via createImageBitmap), run apriltag-js detection, and display results. If a file detects a tag with the same numeric filename, it is marked match.</div>

    <div class="panel">
      <div style="flex:1;min-width:420px">
        <div class="results" id="uploadResults">
          <div class="muted">Upload results will appear here after processing.</div>
        </div>
      </div>

      <div style="width:320px">
        <div class="muted">Detector status</div>
        <div id="detectorStatus" style="background:#fff;padding:8px;border-radius:8px;border:1px solid #eee;margin-top:8px">idle</div>

        <div class="muted" style="margin-top:12px">Notes</div>
        <div class="muted" style="margin-top:6px">- SVGs are rasterized at the chosen "Raster max dim". Increase to 1600 if small tags don't detect.<br>- If canvas read is blocked it's likely due to external references in the SVG (fonts/images). Inline everything in that case.</div>
      </div>
    </div>
  </div>

  <!-- apriltag-js (WASM) -->
  <script defer src="https://unpkg.com/apriltag-js@0.1.4/dist/apriltag.min.js"></script>

  <script>
  (function(){
    // Handles SVG rasterization + apriltag-js detection for uploaded images.
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const uploadResults = document.getElementById('uploadResults');
    const detectorStatus = document.getElementById('detectorStatus');
    const maxDimInput = document.getElementById('maxDim');

    let detector = null;

    async function ensureDetector(timeout = 30000) {
      if (detector) return detector;
      detectorStatus.textContent = 'waiting for apriltag-js...';
      const start = Date.now();
      while (Date.now() - start < timeout) {
        if (window.apriltag && typeof window.apriltag.Detector === 'function') {
          try {
            detector = new window.apriltag.Detector({ families: ['tag36h11'] });
            detectorStatus.textContent = 'ready';
            return detector;
          } catch (e) {
            console.warn('Detector construct error, retrying...', e);
            detectorStatus.textContent = 'construct error, retrying...';
          }
        } else {
          detectorStatus.textContent = 'library loading...';
        }
        await new Promise(r => setTimeout(r, 250));
      }
      detectorStatus.textContent = 'failed to load apriltag-js';
      throw new Error('apriltag-js init timeout');
    }

    // Rasterize uploaded file to ImageData. Handles SVG via createImageBitmap (preferred).
    async function rasterizeFileToImageData(file, maxDim = 1200) {
      // Preferred path: createImageBitmap(file) — works well for SVG and images
      try {
        const bitmap = await createImageBitmap(file);
        let iw = bitmap.width, ih = bitmap.height;
        const scale = Math.min(1, maxDim / Math.max(iw, ih));
        const w = Math.round(iw * scale), h = Math.round(ih * scale);
        const tmp = document.createElement('canvas');
        tmp.width = w; tmp.height = h;
        const tctx = tmp.getContext('2d');
        // Draw onto tmp canvas
        tctx.drawImage(bitmap, 0, 0, w, h);
        return tctx.getImageData(0, 0, w, h);
      } catch (err) {
        // Fallback: use Image element (createObjectURL). Necessary on some older browsers.
        return await new Promise((resolve, reject) => {
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => {
            try {
              let iw = img.naturalWidth, ih = img.naturalHeight;
              const scale = Math.min(1, maxDim / Math.max(iw, ih));
              const w = Math.round(iw * scale), h = Math.round(ih * scale);
              const tmp = document.createElement('canvas');
              tmp.width = w; tmp.height = h;
              const tctx = tmp.getContext('2d');
              tctx.drawImage(img, 0, 0, w, h);
              const data = tctx.getImageData(0, 0, w, h);
              URL.revokeObjectURL(url);
              resolve(data);
            } catch (e) {
              URL.revokeObjectURL(url);
              reject(e);
            }
          };
          img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
          img.src = url;
        });
      }
    }

    // Annotate the image with detection overlay and return a data URL preview
    function annotatedDataUrlFromImageData(imageData, dets) {
      const c = document.createElement('canvas');
      c.width = imageData.width; c.height = imageData.height;
      const cx = c.getContext('2d');
      cx.putImageData(imageData, 0, 0);
      if (dets && dets.length) {
        cx.strokeStyle = 'lime';
        cx.fillStyle = 'rgba(0,255,0,0.25)';
        cx.lineWidth = Math.max(1, Math.round(c.height / 360));
        for (const d of dets) {
          const cs = d.corners || d.c || [];
          let cxcent = 0, cycent = 0;
          for (const p of cs) { cxcent += p.x; cycent += p.y; }
          const n = Math.max(1, cs.length);
          cxcent /= n; cycent /= n;
          cx.beginPath(); cx.arc(cxcent, cycent, Math.max(3, c.height/200), 0, Math.PI*2); cx.fill();
          if (cs.length === 4) {
            cx.beginPath(); cx.moveTo(cs[0].x, cs[0].y);
            for (let i=1;i<4;i++) cx.lineTo(cs[i].x, cs[i].y);
            cx.closePath(); cx.stroke();
          }
          // draw id label
          cx.fillStyle = 'yellow';
          cx.font = `${Math.max(10, Math.round(c.height/30))}px sans-serif`;
          cx.fillText(String(d.id ?? d.tag_id ?? '-'), (cs[0]?.x || cxcent) + 6, (cs[0]?.y || cycent) + 6);
          cx.fillStyle = 'rgba(0,255,0,0.25)';
        }
      }
      return c.toDataURL('image/png');
    }

    // Build a short human readable row for each processed file
    function resultRowElement({ fileName, expectedId, detectedIds = [], annotatedDataUrl, statusText, error }) {
      const row = document.createElement('div');
      row.className = 'file-row';
      const left = document.createElement('div');
      left.style.display = 'flex'; left.style.alignItems = 'center';
      // preview canvas (img)
      const img = document.createElement('img');
      img.className = 'preview';
      img.src = annotatedDataUrl || '';
      left.appendChild(img);
      const info = document.createElement('div'); info.className = 'file-info';
      const title = document.createElement('div');
      title.innerHTML = `<strong>${fileName}</strong> ${expectedId ? '<span class="tag-pill">expected: '+expectedId+'</span>' : ''}`;
      info.appendChild(title);
      const st = document.createElement('div'); st.className = 'muted';
      st.textContent = statusText || '';
      info.appendChild(st);
      if (error) {
        const e = document.createElement('div'); e.className = 'bad'; e.textContent = String(error);
        info.appendChild(e);
      } else if (detectedIds && detectedIds.length) {
        const d = document.createElement('div');
        d.innerHTML = `detected: ${detectedIds.map(id => `<strong>${id}</strong>`).join(', ')}`;
        info.appendChild(d);
      }
      left.appendChild(info);
      row.appendChild(left);
      return row;
    }

    // Main handler
    processBtn.addEventListener('click', async () => {
      const files = Array.from(fileInput.files || []);
      if (!files.length) {
        uploadResults.innerHTML = '<div class="muted">No files selected.</div>';
        return;
      }
      uploadResults.innerHTML = '<div class="muted">Preparing detector…</div>';
      try {
        await ensureDetector(45000);
      } catch (e) {
        uploadResults.innerHTML = `<div class="bad">apriltag-js failed to initialize: ${e.message}</div>`;
        console.error(e);
        return;
      }

      uploadResults.innerHTML = '';
      const maxDim = Math.max(200, parseInt(maxDimInput.value, 10) || 1200);

      for (const f of files) {
        const fname = f.name;
        // derive expected id from filename (strip extension)
        const expected = fname.replace(/\.[^/.]+$/, '');
        let annotated = null;
        let detectedIds = [];
        let statusText = '';
        let error = null;
        try {
          const imageData = await rasterizeFileToImageData(f, maxDim);
          // run detection
          let dets = [];
          try {
            dets = detector.detect(imageData) || [];
          } catch (de) {
            // sometimes detection throws on unexpected data
            console.error('detect error for', fname, de);
            throw de;
          }
          detectedIds = dets.map(d => (d.id ?? d.tag_id ?? -1));
          if (!dets.length) {
            statusText = 'No AprilTag detected';
          } else {
            statusText = dets.length === 1 ? 'One tag detected' : `${dets.length} tags detected`;
            // annotate preview
            annotated = annotatedDataUrlFromImageData(imageData, dets);
            // if expected is numeric-ish, check if any detectedId equals it
            const expectedMatch = detectedIds.some(id => String(id) === String(expected));
            if (expected && expectedMatch) statusText += ' — MATCH';
            else if (expected) statusText += ' — MISMATCH';
          }
        } catch (e) {
          console.error('Processing error for', fname, e);
          error = e.message || String(e);
          statusText = 'Error processing file';
        }
        const el = resultRowElement({ fileName: fname, expectedId: expected, detectedIds, annotatedDataUrl: annotated, statusText, error });
        uploadResults.appendChild(el);
      }
      detectorStatus.textContent = 'ready';
    });

    // small helpful hint: show when apriltag library failed network load
    setTimeout(() => {
      if (!window.apriltag) {
        detectorStatus.textContent = 'apriltag-js not loaded (check console/network)';
      }
    }, 1200);

    // Expose helpers for console debugging
    window._svgUploader = { ensureDetector, rasterizeFileToImageData };
  })();
  </script>
</body>
</html>
