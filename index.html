<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>QR Lap Tracker</title>
<style>
  :root {
    --accent: #036;
    --bg: #fafafa;
  }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: #111;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    background: #fff;
    border-bottom: 1px solid #e6e6e6;
    padding: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }

  button {
    background: var(--accent);
    color: #fff;
    border: 0;
    padding: 10px 12px;
    border-radius: 8px;
    font-weight: 600;
  }
  button.secondary {
    background: #666;
  }

  #layout {
    flex: 1;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
  }

  #video-container, #results-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: auto;
    padding: 8px;
  }

  #video {
    width: 100%;
    height: auto;
    border-radius: 10px;
    background: #000;
  }

  #canvas {
    display: none;
  }

  #status {
    font-size: 14px;
    color: #444;
    margin-top: 8px;
    text-align: center;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
  }

  thead {
    background: var(--accent);
    color: #fff;
  }

  th, td {
    padding: 8px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
  }

  tr.done {
    background: #e9f6ec;
  }

  /* Landscape layout: split left/right */
  @media (orientation: landscape) {
    #layout {
      flex-direction: row;
    }
    #video-container, #results-container {
      width: 50%;
      height: 100%;
    }
    #video {
      width: 90%;
      height: auto;
    }
  }
</style>
</head>
<body>

<header>
  <button id="enableBtn">Enable Camera</button>
  <button id="startBtn" class="secondary" disabled>Start</button>
  <button id="stopBtn" class="secondary" disabled>Stop</button>
  <button id="exportBtn" class="secondary" disabled>Export CSV</button>
  <label>Laps:
    <select id="lapsSelect">
      <option value="1">1</option><option value="2">2</option>
      <option value="3">3</option><option value="4" selected>4</option>
      <option value="5">5</option><option value="6">6</option>
      <option value="7">7</option><option value="8">8</option>
    </select>
  </label>
  <div id="timer">00:00</div>
</header>

<div id="layout">
  <div id="video-container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div id="status">Idle. Click "Enable Camera".</div>
  </div>

  <div id="results-container">
    <table>
      <thead><tr><th>ID</th><th>Laps</th><th>Finish</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- QR detection library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script>

<script>
(function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const enableBtn = document.getElementById('enableBtn');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const exportBtn = document.getElementById('exportBtn');
  const tbody = document.getElementById('tbody');
  const statusEl = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const lapsSelect = document.getElementById('lapsSelect');

  let stream = null;
  let running = false, counting = false;
  let startTime = 0, timerInt = null;
  const COOLDOWN = 1500;
  const runners = {};
  const guideYRatio = 0.7;

  function setStatus(msg){ statusEl.textContent = msg; console.log(msg); }
  function msToMMSS(ms){ const s=Math.floor(ms/1000); return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }

  function ensureRow(id){
    if (runners[id]) return;
    runners[id] = { laps:0, done:false, last:0, finish:'-' };
    const tr=document.createElement('tr'); tr.id='r-'+id;
    tr.innerHTML=`<td>${id}</td><td id="laps-${id}">0</td><td id="fin-${id}">-</td>`;
    tbody.appendChild(tr);
  }

  function updateRow(id){
    document.getElementById('laps-'+id).textContent=runners[id].laps;
    document.getElementById('fin-'+id).textContent=runners[id].finish;
    if (runners[id].done) document.getElementById('r-'+id).classList.add('done');
  }

  function countLap(id){
    if (!counting) return;
    const now=Date.now();
    const r=runners[id];
    if (r.done) return;
    if (now - r.last < COOLDOWN) return;
    r.laps++; r.last=now;
    const req=parseInt(lapsSelect.value,10);
    if (r.laps >= req){ r.done=true; r.finish=msToMMSS(now - startTime); }
    updateRow(id);
    setStatus(`QR ${id} lap ${r.laps}${r.done?' — finished':''}`);
  }

  async function enableCamera(){
    if (!navigator.mediaDevices) { setStatus('Camera not supported'); return; }
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width:{ideal:1280}, height:{ideal:720} },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      setStatus('Camera enabled. Press Start to begin scanning.');
      enableBtn.disabled = true; startBtn.disabled = false;
    } catch(e){
      setStatus('Camera error: '+e.message);
    }
  }

  function startCounting(){
    if (!stream) { setStatus('Enable camera first'); return; }
    counting = true; startTime = Date.now();
    timerEl.textContent='00:00';
    timerInt = setInterval(()=>{ timerEl.textContent=msToMMSS(Date.now()-startTime); },1000);
    startBtn.disabled = true; stopBtn.disabled = false; exportBtn.disabled = true;
    running = true;
    scanLoop();
    setStatus('Counting started');
  }

  function stopCounting(){
    counting = false;
    clearInterval(timerInt);
    stopBtn.disabled = true; exportBtn.disabled = false; startBtn.disabled = false;
    for (const id in runners) {
      if (!runners[id].done){ runners[id].finish='DNF'; updateRow(id); }
    }
    setStatus('Counting stopped — export available');
  }

  function exportCSV(){
    const rows=[['ID','Laps','Finish']];
    for (const id of Object.keys(runners)){
      const r=runners[id];
      rows.push([id,r.laps,r.finish]);
    }
    const csv=rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='laps_'+new Date().toISOString()+'.csv';
    document.body.appendChild(a);
    a.click(); a.remove();
    exportBtn.disabled=true;
  }

  async function scanLoop(){
    if (!running) return;
    if (video.readyState>=2){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts:"dontInvert" });
      const guideY = canvas.height * guideYRatio;

      // red guide line
      ctx.strokeStyle='red'; ctx.lineWidth=Math.max(3,canvas.height/220);
      ctx.beginPath(); ctx.moveTo(0,guideY); ctx.lineTo(canvas.width,guideY); ctx.stroke();

      if (code){
        ctx.beginPath(); ctx.lineWidth=3; ctx.strokeStyle='lime';
        ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
        ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
        ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
        ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
        ctx.closePath(); ctx.stroke();

        const id = code.data.trim();
        const cy = (code.location.topLeftCorner.y + code.location.bottomLeftCorner.y +
                    code.location.topRightCorner.y + code.location.bottomRightCorner.y)/4;
        ensureRow(id);
        if (Math.abs(cy - guideY) < Math.max(16, canvas.height/60)) countLap(id);
      }
    }
    requestAnimationFrame(scanLoop);
  }

  enableBtn.addEventListener('click', enableCamera);
  startBtn.addEventListener('click', startCounting);
  stopBtn.addEventListener('click', stopCounting);
  exportBtn.addEventListener('click', exportCSV);
})();
</script>
</body>
</html>