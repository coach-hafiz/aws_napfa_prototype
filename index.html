<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArUco Lap Counter (Stable Version)</title>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f5f5f5; }
    .controls {
      position: sticky; top: 0; background: #fff; z-index: 10;
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
      padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #015871; color: white; border: none; border-radius: 8px;
      font-size: 16px; padding: 8px 16px;
    }
    button.secondary { background: #666; }
    input[type="number"] {
      border: 1px solid #ccc; border-radius: 8px; padding: 6px; width: 80px;
      font-size: 16px;
    }
    video, canvas { width: 100%; display: block; }
    canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
    .stage { position: relative; background: #000; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff;
    }
    th, td {
      border: 1px solid #ccc; text-align: center; padding: 6px;
    }
    th { background: #015871; color: #fff; }
    tr.done { background: #d8f3dc; }
  </style>
</head>
<body>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="secondary">Stop</button>
    <div id="timer" style="font-weight:700;">00:00</div>
    <label>Req Laps:</label><input id="reqLaps" type="number" value="4" min="1" max="50" />
  </div>

  <div class="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <table>
    <thead><tr><th>Runner ID</th><th>Laps</th><th>Finish Time</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>

  <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onCvReady()"></script>
  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let tbody = document.getElementById('tbody');
    let timerEl = document.getElementById('timer');
    let reqInput = document.getElementById('reqLaps');

    let streaming = false, counting = false, startTime = 0, timerInt = null;
    const runners = {}, COOLDOWN = 2000;
    let guideY = 0;

    async function initCamera() {
      const constraints = {
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      return new Promise(res => video.onloadedmetadata = () => res());
    }

    function fitCanvas() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      guideY = Math.round(canvas.height * 0.7);
    }

    function drawGuide() {
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(0, guideY);
      ctx.lineTo(canvas.width, guideY);
      ctx.stroke();
    }

    function addRunner(id) {
      if (runners[id]) return;
      runners[id] = { laps: 0, done: false, last: 0, finish: '-' };
      const tr = document.createElement('tr');
      tr.id = `r${id}`;
      tr.innerHTML = `<td>${id}</td><td id="laps${id}">0</td><td id="fin${id}">-</td>`;
      tbody.appendChild(tr);
    }

    function updateRunner(id) {
      document.getElementById(`laps${id}`).textContent = runners[id].laps;
      document.getElementById(`fin${id}`).textContent = runners[id].finish;
    }

    function markDone(id) {
      document.getElementById(`r${id}`)?.classList.add('done');
    }

    function countLap(id) {
      const now = Date.now();
      const r = runners[id];
      const required = parseInt(reqInput.value);
      if (r.done) return;
      if (now - r.last < COOLDOWN) return;
      r.laps++;
      r.last = now;
      if (r.laps >= required) {
        r.done = true;
        const sec = Math.floor((now - startTime) / 1000);
        const mm = String(Math.floor(sec / 60)).padStart(2, "0");
        const ss = String(sec % 60).padStart(2, "0");
        r.finish = `${mm}:${ss}`;
        markDone(id);
      }
      updateRunner(id);
    }

    function updateTimer() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      const mm = String(Math.floor(s / 60)).padStart(2, "0");
      const ss = String(s % 60).padStart(2, "0");
      timerEl.textContent = `${mm}:${ss}`;
    }

    function onCvReady() {
      cv['onRuntimeInitialized'] = async () => {
        await initCamera();
        fitCanvas();

        // Init Mats and dictionary
        const src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        const gray = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
        const dict = new cv.aruco.Dictionary_get(cv.aruco.DICT_6X6_50);
        const params = new cv.aruco.DetectorParameters_create();

        console.log('OpenCV and Camera ready.');

        function processFrame() {
          if (!streaming && video.readyState < 2) {
            requestAnimationFrame(processFrame);
            return;
          }

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          src.data.set(imgData.data);
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

          let corners = new cv.MatVector();
          let ids = new cv.Mat();

          cv.aruco.detectMarkers(gray, dict, corners, ids, params);

          drawGuide(); // Always show red line

          if (!ids.empty()) {
            cv.aruco.drawDetectedMarkers(src, corners, ids);
            cv.imshow('canvas', src);

            for (let i = 0; i < ids.rows; i++) {
              const id = ids.data32S[i];
              addRunner(id);

              const c = corners.get(i);
              let cy = 0;
              for (let k = 0; k < 4; k++) cy += c.data64F[k * 2 + 1];
              cy /= 4;

              if (Math.abs(cy - guideY) < 20 && counting) countLap(id);
            }
          }

          requestAnimationFrame(processFrame);
        }

        streaming = true;
        requestAnimationFrame(processFrame);
      };
    }

    document.getElementById('startBtn').onclick = () => {
      counting = true;
      startTime = Date.now();
      if (!timerInt) timerInt = setInterval(updateTimer, 1000);
    };

    document.getElementById('stopBtn').onclick = () => {
      counting = false;
      clearInterval(timerInt);
      timerInt = null;
    };
  </script>
</body>
</html>
