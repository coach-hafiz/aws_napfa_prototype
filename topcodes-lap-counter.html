<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>TopCodes Lap Counter — Stable</title>
<style>
:root{
  --accent:#015871;
  --bg:#f7f7f7;
  --line:red;
}
*{ box-sizing:border-box }
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:#111;
}
.app{ display:grid; min-height:100vh; }

/* Portrait: video top quarter, table bottom */
@media (orientation:portrait){
  .app{
    grid-template-rows: 25vh 1fr;
    grid-template-columns: 1fr;
    grid-template-areas:
      "top"
      "bottom";
  }
  .top{ grid-area: top; }
  .bottom{ grid-area: bottom; }
}

/* Landscape: video left, table right */
@media (orientation:landscape){
  .app{
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 100vh;
    grid-template-areas:
      "left right";
  }
  .top{ grid-area: left; height:100vh; }
  .bottom{ grid-area: right; height:100vh; }
}

.top{
  position:relative;
  background:#000;
  overflow:hidden;
}
#view{
  width:100%;
  height:100%;
  display:block;
  background:#000;
  touch-action:none;
}
.controls{
  position:absolute;
  left:0; right:0; top:0;
  z-index:20;
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  padding:8px;
  background:linear-gradient(180deg,
    rgba(255,255,255,0.95) 0%,
    rgba(255,255,255,0.80) 90%,
    rgba(255,255,255,0) 100%);
  border-bottom:1px solid rgba(0,0,0,0.06);
}
button{
  background:var(--accent);
  color:#fff;
  border:0;
  border-radius:10px;
  font-weight:700;
  padding:10px 12px;
  cursor:pointer;
}
button.secondary{ background:#666 }
button:disabled{ opacity:0.5; cursor:default }
select{
  height:42px;
  padding:0 10px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#fff;
  font-weight:600;
}
.timer{
  font-variant-numeric:tabular-nums;
  font-weight:700;
  min-width:78px;
}
.spacer{ flex:1 1 auto }

.bottom{
  display:grid;
  grid-template-rows: auto 1fr auto;
  gap:8px;
  padding:10px;
  min-height:0;
}
.status{
  font-size:13px;
  color:#333;
  white-space:pre-wrap;
  background:#fff;
  border:1px solid #eee;
  border-radius:10px;
  padding:8px;
}
.tableWrap{
  min-height:0;
  background:#fff;
  border:1px solid #eee;
  border-radius:10px;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
thead th{
  position:sticky;
  top:0;
  background:var(--accent);
  color:#fff;
  padding:8px;
  z-index:1;
}
td,th{
  padding:8px;
  border-bottom:1px solid #f0f0f0;
  text-align:center;
}
tr.done{ background:#e9f6ec }

.footerBar{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  font-size:12px;
  color:#444;
}

@media (max-width:420px){
  button{ padding:8px 10px }
  .timer{ min-width:66px }
  select{ height:38px }
}
</style>
</head>
<body>
<div class="app">
  <section class="top">
    <canvas id="view" aria-label="Camera view with overlay and start line"></canvas>
    <div class="controls">
      <button id="enableBtn">Enable Camera</button>
      <button id="startBtn" class="secondary" disabled>Start</button>
      <button id="stopBtn"  class="secondary" disabled>Stop</button>
      <div class="timer" id="timer">00:00</div>

      <label for="lapsSel"
             style="margin-left:6px;font-size:12px;color:#333">Laps</label>
      <select id="lapsSel" aria-label="Number of laps"></select>

      <button id="exportBtn" class="secondary" disabled>Export CSV</button>

      <span class="spacer"></span>

      <span style="font-size:11px;color:#555">
        Aim TopCodes so they cross the red line.
      </span>
    </div>
  </section>

  <section class="bottom">
    <div class="status" id="status">Idle. Tap “Enable Camera”.</div>
    <div class="tableWrap">
      <table>
        <thead>
        <tr>
          <th>Runner ID</th>
          <th>Laps</th>
          <th>Finish</th>
          <th>Splits (mm:ss, …)</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footerBar">
      • Use large matte TopCodes • Good lighting improves scans • Codes auto-map to runners (TopCode → ID 1–20)
    </div>
  </section>
</div>

<!-- TopCodes library (only external dependency) -->
<script src="https://cdn.jsdelivr.net/gh/TIDAL-Lab/TopCodes@master/javascript/topcodes.js"></script>

<script>
(() => {
  const canvas   = document.getElementById('view');
  const ctx      = canvas.getContext('2d', { willReadFrequently:true });

  const statusEl = document.getElementById('status');
  const tbody    = document.getElementById('tbody');
  const timerEl  = document.getElementById('timer');
  const enableBtn= document.getElementById('enableBtn');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const exportBtn= document.getElementById('exportBtn');
  const lapsSel  = document.getElementById('lapsSel');

  // Populate laps 1–20 (default 4)
  for (let i=1;i<=20;i++){
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=i;
    if(i===4) opt.selected=true;
    lapsSel.appendChild(opt);
  }

  // TopCode → Runner ID mapping
  const TOPCODE_MAP = {
    31:1,47:2,55:3,59:4,61:5,
    79:6,87:7,91:8,93:9,103:10,
    107:11,109:12,115:13,117:14,121:15,
    143:16,151:17,155:18,157:19,167:20
  };
  const mapCode = raw => TOPCODE_MAP.hasOwnProperty(raw) ? TOPCODE_MAP[raw] : null;

  // State
  let counting    = false;
  let startTime   = 0;
  let timerTick   = null;
  let lineY       = null;  // computed from canvas height after first frame
  let lastCanvasW = 0;
  let lastCanvasH = 0;
  const COOLDOWN  = 1200;  // ms between laps for same runner
  const runners   = new Map(); // runnerID -> {laps: [ms,...], lastTs, finished}

  const setStatus = (...parts) => {
    const msg = parts.join(' ');
    statusEl.textContent = msg;
    console.log(msg);
  };

  const msToMMSS = ms => {
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const ss= s % 60;
    return String(m).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
  };

  function ensureRunner(id){
    if (!runners.has(id)){
      runners.set(id, { laps:[], lastTs:0, finished:false });
      const tr = document.createElement('tr');
      tr.id = 'r-'+id;
      tr.innerHTML = `
        <td>${id}</td>
        <td id="laps-${id}">0</td>
        <td id="fin-${id}">-</td>
        <td id="splits-${id}">-</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function updateRunnerRow(id){
    const r = runners.get(id);
    const lapsCount = r.laps.length;
    document.getElementById(\`laps-\${id}\`).textContent   = lapsCount;
    document.getElementById(\`fin-\${id}\`).textContent    = lapsCount ? msToMMSS(r.laps[lapsCount-1]) : '-';
    document.getElementById(\`splits-\${id}\`).textContent = lapsCount ? r.laps.map(msToMMSS).join(' | ') : '-';
    if (r.finished){
      const row = document.getElementById('r-'+id);
      if (row) row.classList.add('done');
    }
  }

  function countLap(id){
    const r   = runners.get(id);
    const now = Date.now();
    const req = parseInt(lapsSel.value,10);

    if (r.finished) return;
    if (now - r.lastTs < COOLDOWN) return;

    r.laps.push(now - startTime);
    r.lastTs = now;

    if (r.laps.length >= req){
      r.finished = true;
    }

    updateRunnerRow(id);

    setStatus(\`Runner \${id} → Lap \${r.laps.length}\${r.finished ? ' (Finished)' : ''}\`);
  }

  function startTimer(){
    startTime = Date.now();
    timerEl.textContent = '00:00';
    timerTick = setInterval(()=>{
      timerEl.textContent = msToMMSS(Date.now()-startTime);
    }, 1000);
  }

  function stopTimer(){
    if (timerTick){
      clearInterval(timerTick);
      timerTick = null;
    }
  }

  // TopCodes frame callback
  let frameSkip = 0;
  function handleFrame(jsonString){
    let data;
    try {
      data = JSON.parse(jsonString);
    } catch(e){
      return;
    }
    const tcodes = data.topcodes || [];

    // TopCodes sets the canvas size to match the video feed.
    // Recompute lineY when that happens (but we NEVER change canvas size ourselves).
    if (canvas.width !== lastCanvasW || canvas.height !== lastCanvasH){
      lastCanvasW = canvas.width  || lastCanvasW || 640;
      lastCanvasH = canvas.height || lastCanvasH || 480;
      lineY = Math.round(lastCanvasH * 0.5);  // midway vertically
    }
    if (lineY == null){
      // first frames may arrive before dimensions are set
      return;
    }

    // Draw red line overlay every 2nd frame (reduces work, avoids flicker)
    frameSkip++;
    if (frameSkip % 2 === 0){
      const h = canvas.height || lastCanvasH;
      const w = canvas.width  || lastCanvasW;
      ctx.save();
      ctx.strokeStyle = getComputedStyle(document.documentElement)
        .getPropertyValue('--line').trim() || 'red';
      ctx.lineWidth = Math.max(3, h/220);
      ctx.beginPath();
      ctx.moveTo(0, lineY);
      ctx.lineTo(w, lineY);
      ctx.stroke();
      ctx.restore();
    }

    if (!counting) return;

    const now = Date.now();
    const h   = canvas.height || lastCanvasH || 480;
    const thresholdBase = Math.max(16, h/10); // vertical tolerance around line

    for (const tc of tcodes){
      const rawCode  = tc.code;
      const runnerID = mapCode(rawCode);
      if (!runnerID) continue;

      const cy     = tc.y;
      const radius = tc.radius || 20;

      if (Math.abs(cy - lineY) <= Math.max(thresholdBase, radius*0.9)){
        ensureRunner(runnerID);
        countLap(runnerID);
      }
    }
  }

  // Buttons
  enableBtn.addEventListener('click', () => {
    try{
      // Let TopCodes own the camera & canvas completely
      TopCodes.startStopVideoScan('view');
      TopCodes.setVideoFrameCallback('view', handleFrame);

      enableBtn.disabled = true;
      startBtn.disabled  = false;
      stopBtn.disabled   = true;
      exportBtn.disabled = true;

      setStatus('Camera enabled. Aim TopCodes at the red line. Tap “Start” to begin timing.');
    }catch(e){
      console.error(e);
      setStatus('Camera error: ' + (e.message || e));
      enableBtn.disabled = false;
    }
  });

  startBtn.addEventListener('click', () => {
    runners.clear();
    tbody.innerHTML = '';

    counting = true;
    startTimer();

    startBtn.disabled  = true;
    stopBtn.disabled   = false;
    exportBtn.disabled = true;

    setStatus('Counting laps…');
  });

  stopBtn.addEventListener('click', () => {
    if (!counting) return;
    counting = false;
    stopTimer();

    // Mark unfinished as DNF
    for (const [id, r] of runners.entries()){
      if (!r.finished){
        const finCell = document.getElementById('fin-'+id);
        if (finCell) finCell.textContent = 'DNF';
      }
    }

    startBtn.disabled  = false;
    stopBtn.disabled   = true;
    exportBtn.disabled = runners.size === 0; // enable if we have data

    setStatus('Stopped. You can export CSV now.');
  });

  exportBtn.addEventListener('click', () => {
    if (!runners.size){
      setStatus('No data to export.');
      return;
    }

    let maxLaps = 0;
    for (const r of runners.values()){
      if (r.laps.length > maxLaps) maxLaps = r.laps.length;
    }

    const rows = [];
    const header = ['Runner ID', 'Total Laps', 'Finish'];
    for (let i=1;i<=maxLaps;i++) header.push(\`Lap \${i}\`);
    rows.push(header);

    for (const [id, r] of runners.entries()){
      const total  = r.laps.length;
      const finish = total ? msToMMSS(r.laps[total-1]) : 'DNF';
      const row    = [id, String(total), finish];
      for (let i=0;i<maxLaps;i++){
        row.push(r.laps[i] != null ? msToMMSS(r.laps[i]) : '');
      }
      rows.push(row);
    }

    const csv = rows.map(r =>
      r.map(c => {
        const s = String(c);
        return s.includes(',') ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(',')
    ).join('\n');

    // Data URL for Safari-friendly download
    const encoded = encodeURIComponent(csv);
    const href    = 'data:text/csv;charset=utf-8,' + encoded;
    const a       = document.createElement('a');
    a.href        = href;
    a.download    = 'topcodes_laps_' + new Date().toISOString().replace(/[:.]/g,'-') + '.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();

    setStatus('CSV exported.');
  });

  // Initial UI
  setStatus('Idle. Tap “Enable Camera”.');
})();
</script>
</body>
</html>
