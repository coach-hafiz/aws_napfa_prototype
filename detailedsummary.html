<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Run Feedback ‚Äî Your Summary</title>
<style>
:root{
  --accent:#015871;
  --bg:#f6f7f9;
  --card:#ffffff;
  --muted:#64748b;
  --line:#e5e7eb;
  --good:#16a34a;
  --warn:#f59e0b;
  --bad:#ef4444;
  --shadow: 0 10px 22px rgba(0,0,0,.08);
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:#0f172a;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
  border-bottom:1px solid var(--line);
  backdrop-filter: blur(8px);
}
.headerInner{
  max-width:1100px;
  margin:0 auto;
  padding:12px 14px;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.brand{
  display:flex;
  gap:10px;
  align-items:center;
  min-width:220px;
}
.badge{
  width:38px;height:38px;
  border-radius:12px;
  background:var(--accent);
  color:#fff;
  display:grid;
  place-items:center;
  font-weight:900;
}
h1{
  font-size:16px;
  margin:0;
  line-height:1.1;
}
.sub{
  font-size:12px;
  color:var(--muted);
  margin:0;
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  flex:1 1 auto;
  justify-content:flex-end;
  flex-wrap:wrap;
}
select, button{
  height:40px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  padding:0 12px;
  font-weight:800;
}
button{
  cursor:pointer;
  border:0;
  background:var(--accent);
  color:#fff;
}
button.secondary{
  background:#6b7280;
}

main{
  max-width:1100px;
  margin:0 auto;
  padding:14px;
  display:grid;
  grid-template-columns: 1.25fr .75fr;
  gap:14px;
}
@media (max-width:980px){
  main{ grid-template-columns:1fr; }
  .controls{ justify-content:flex-start; }
  .brand{ min-width:unset; }
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:18px;
  box-shadow: var(--shadow);
  overflow:hidden;
}
.cardHeader{
  padding:12px 14px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.cardTitle{
  margin:0;
  font-size:14px;
}
.cardHint{
  margin:2px 0 0 0;
  font-size:12px;
  color:var(--muted);
}

.cardBody{ padding:12px 14px; }

.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media (max-width:620px){
  .grid2{ grid-template-columns:1fr; }
}

.bigNumber{
  font-size:30px;
  font-weight:950;
  letter-spacing:-0.02em;
  margin:0;
}
.smallLabel{
  margin:0;
  color:var(--muted);
  font-size:12px;
  font-weight:700;
}

.pillRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}
.pill{
  font-size:12px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#fff;
}
.pill.good{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.10); color:#0f5f2c; }
.pill.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12); color:#7a4b00; }
.pill.bad { border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12); color:#7a0c0c; }

.bar{
  height:10px;
  background:#eef2f7;
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(0,0,0,.04);
}
.bar > div{
  height:100%;
  width:0%;
  background:var(--accent);
  border-radius:999px;
}

.sparkWrap{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px;
  background:#fff;
}
.sparkTitle{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}
.sparkTitle b{ font-size:13px; }
.sparkTitle span{ font-size:12px; color:var(--muted); }

.small{
  font-size:12px;
  color:var(--muted);
}

.hr{ height:1px; background:var(--line); margin:12px 0; }

.iconRow{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:10px;
}
@media (max-width:620px){
  .iconRow{ grid-template-columns:repeat(2, 1fr); }
}
.tile{
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px;
  background:#fff;
}
.tile .icon{
  width:44px;height:44px;
  border-radius:16px;
  display:grid;
  place-items:center;
  font-weight:950;
  color:#fff;
  background:var(--accent);
  margin-bottom:8px;
}
.tile b{ font-size:13px; display:block; margin-bottom:4px; }
.tile span{ font-size:12px; color:var(--muted); display:block; }

.q{
  display:grid;
  gap:10px;
}
.q .item{
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px 12px;
  background:#fff;
}
.q .item b{
  display:block;
  font-size:13px;
  margin-bottom:4px;
}
.q .item span{
  display:block;
  font-size:12px;
  color:var(--muted);
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:10px 8px;
  border-bottom:1px solid #f1f5f9;
  text-align:center;
}
th{
  color:#fff;
  background:var(--accent);
  position:sticky;
  top:0;
}
tbody tr:nth-child(even){ background:#fafafa; }
tbody tr.me{ outline:2px solid rgba(1,88,113,.22); outline-offset:-2px; background:rgba(1,88,113,.06); }

.notice{
  max-width:900px;
  margin:16px auto;
  padding:14px;
  background:#fff;
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow);
}

footer{
  max-width:1100px;
  margin:0 auto;
  padding:10px 14px 24px 14px;
  color:var(--muted);
  font-size:12px;
}
</style>
</head>
<body>

<header>
  <div class="headerInner">
    <div class="brand">
      <div class="badge">R</div>
      <div>
        <h1>Your Run Feedback</h1>
        <p class="sub" id="metaLine">Loading‚Ä¶</p>
      </div>
    </div>

    <div class="controls">
      <label class="small" for="runnerSel" style="font-weight:900;color:#0f172a;">View</label>
      <select id="runnerSel" aria-label="Select runner"></select>
      <button id="shareBtn" class="secondary" type="button">Copy Link</button>
      <button id="clearBtn" type="button">Clear Data</button>
    </div>
  </div>
</header>

<div id="noData" class="notice" style="display:none;">
  <b>No run data found.</b>
  <div class="small" style="margin-top:6px;">
    Go back to the lap counter page, press <b>Stop</b>, then <b>Detailed Summary</b>.
  </div>
</div>

<main id="app" style="display:none;">
  <!-- LEFT: learner-friendly feedback -->
  <section class="card">
    <div class="cardHeader">
      <div>
        <p class="cardTitle" id="runnerTitle">Runner</p>
        <p class="cardHint">This page is for you: rhythm, feelings, effort, and support.</p>
      </div>
      <div class="pill" id="finishPill">‚Äî</div>
    </div>

    <div class="cardBody">
      <div class="grid2">
        <div class="tile">
          <div class="icon" style="background:var(--good);">‚è±</div>
          <b id="finishLabel">Finish time</b>
          <p class="bigNumber" id="finishTime" style="margin:6px 0 0 0;">‚Äî</p>
          <div class="pillRow" id="finishPills"></div>
        </div>

        <div class="tile">
          <div class="icon" style="background:#3b82f6;">„Ä∞</div>
          <b>Rhythm score</b>
          <p class="bigNumber" id="rhythmScore" style="margin:6px 0 0 0;">‚Äî</p>
          <div class="bar" title="Rhythm consistency">
            <div id="rhythmBar"></div>
          </div>
          <div class="small" id="rhythmNote" style="margin-top:6px;">‚Äî</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="sparkWrap">
        <div class="sparkTitle">
          <b>Lap trend (your pace story)</b>
          <span id="trendHint">‚Äî</span>
        </div>
        <svg id="spark" width="100%" height="78" viewBox="0 0 600 78" role="img" aria-label="Lap trend sparkline">
          <rect x="0" y="0" width="600" height="78" fill="rgba(1,88,113,.04)"></rect>
          <path id="sparkPath" d="" fill="none" stroke="var(--accent)" stroke-width="3" stroke-linecap="round"></path>
          <circle id="sparkDot" cx="0" cy="0" r="4" fill="var(--accent)"></circle>
        </svg>
        <div class="small" id="lapList" style="margin-top:8px;">‚Äî</div>
      </div>

      <div class="hr"></div>

      <!-- INFOS: paper-aligned, learner language -->
      <div class="iconRow">
        <div class="tile">
          <div class="icon" style="background:var(--good);">‚ò∫</div>
          <b>Feelings & motivation</b>
          <span>Try: ‚ÄúI found a rhythm.‚Äù ‚ÄúI felt calmer.‚Äù</span>
        </div>
        <div class="tile">
          <div class="icon" style="background:#3b82f6;">ü§ù</div>
          <b>Social awareness</b>
          <span>Notice effort. Encourage, don‚Äôt compare.</span>
        </div>
        <div class="tile">
          <div class="icon" style="background:#8b5cf6;">üß†</div>
          <b>Self-discovery</b>
          <span>Spot flow, fatigue, breathing, steps.</span>
        </div>
        <div class="tile">
          <div class="icon" style="background:#f59e0b;">üí¨</div>
          <b>Learning together</b>
          <span>Talk + feedback = confidence grows.</span>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Quick ‚Äúbetter feedback‚Äù prompt (moves away from only performance) -->
      <div class="tile" style="background:rgba(1,88,113,.05);">
        <b style="margin-bottom:6px;">Better feedback (say this, not that)</b>
        <div class="small" style="color:#0f172a;">
          <div><b>Instead of:</b> ‚ÄúYou ran too slow / too fast.‚Äù</div>
          <div style="margin-top:6px;"><b>Try:</b> ‚ÄúI noticed you kept trying.‚Äù ‚ÄúLet‚Äôs match our rhythm.‚Äù ‚ÄúYou can do it!‚Äù</div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Reflection questions (short + student-facing) -->
      <div class="q">
        <div class="item">
          <b>1) Rhythm</b>
          <span>When did it feel smooth or ‚Äúin flow‚Äù?</span>
        </div>
        <div class="item">
          <b>2) Body signals</b>
          <span>What did you notice (breathing, steps, tiredness)?</span>
        </div>
        <div class="item">
          <b>3) Partner mirror</b>
          <span>What effort did you notice in your partner? What can you encourage?</span>
        </div>
        <div class="item">
          <b>4) Next run goal (pick one)</b>
          <span>Smoother rhythm ‚Ä¢ steadier pace ‚Ä¢ calmer mindset ‚Ä¢ better support</span>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: group snapshot (infographic-ish + minimal words) -->
  <aside class="card">
    <div class="cardHeader">
      <div>
        <p class="cardTitle">Group snapshot</p>
        <p class="cardHint">Cooperation & reflection help everyone enjoy pace running.</p>
      </div>
    </div>

    <div class="cardBody">
      <div class="grid2">
        <div class="tile">
          <div class="icon" style="background:var(--accent);">‚úì</div>
          <b>Completion</b>
          <p class="bigNumber" id="completionPct" style="margin:6px 0 0 0;">‚Äî</p>
          <div class="bar"><div id="completionBar"></div></div>
          <div class="small" id="completionNote" style="margin-top:6px;">‚Äî</div>
        </div>

        <div class="tile">
          <div class="icon" style="background:#0ea5e9;">üå±</div>
          <b>Mindset shift</b>
          <span>From ‚Äúonly time‚Äù ‚Üí to rhythm, effort, and feelings.</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="sparkWrap">
        <div class="sparkTitle">
          <b>Leaderboard (finish)</b>
          <span class="small">DNF at bottom</span>
        </div>
        <div style="max-height:320px; overflow:auto; border-radius:12px;">
          <table aria-label="Leaderboard">
            <thead>
              <tr>
                <th>Runner</th>
                <th>Finish</th>
                <th>Rhythm</th>
              </tr>
            </thead>
            <tbody id="leaderBody"></tbody>
          </table>
        </div>
      </div>

      <div class="hr"></div>

      <div class="tile" style="background:rgba(245,158,11,.10);">
        <b>Quick team challenge</b>
        <span>Pair up and try: ‚ÄúLet‚Äôs match our rhythm for 1 lap.‚Äù</span>
      </div>

      <div class="hr"></div>

      <div class="tile" style="background:rgba(22,163,74,.10);">
        <b>Very short takeaway</b>
        <span>
          Pace running can be meaningful when we run with others, reflect, and encourage.
        </span>
      </div>
    </div>
  </aside>
</main>

<footer>
  Reminder: PE is not only training ‚Äî it‚Äôs also social learning (self-awareness, empathy, motivation, confidence).
</footer>

<script>
(function(){
  var STORE_KEY = 'topcodesLapSummaryV1';

  var metaLine = document.getElementById('metaLine');
  var noData = document.getElementById('noData');
  var app = document.getElementById('app');

  var runnerSel = document.getElementById('runnerSel');
  var shareBtn = document.getElementById('shareBtn');
  var clearBtn = document.getElementById('clearBtn');

  var runnerTitle = document.getElementById('runnerTitle');
  var finishPill = document.getElementById('finishPill');

  var finishTimeEl = document.getElementById('finishTime');
  var finishPills = document.getElementById('finishPills');

  var rhythmScoreEl = document.getElementById('rhythmScore');
  var rhythmBar = document.getElementById('rhythmBar');
  var rhythmNote = document.getElementById('rhythmNote');

  var trendHint = document.getElementById('trendHint');
  var sparkPath = document.getElementById('sparkPath');
  var sparkDot = document.getElementById('sparkDot');
  var lapList = document.getElementById('lapList');

  var completionPct = document.getElementById('completionPct');
  var completionBar = document.getElementById('completionBar');
  var completionNote = document.getElementById('completionNote');
  var leaderBody = document.getElementById('leaderBody');

  function safeParse(json){ try{ return JSON.parse(json); }catch(e){ return null; } }

  function msToMMSS(ms){
    if (!isFinite(ms)) return 'DNF';
    var s = Math.floor(ms/1000);
    var m = Math.floor(s/60);
    var ss= s%60;
    return (m<10?'0':'')+m+':' + (ss<10?'0':'')+ss;
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  function mean(arr){
    var s=0, c=0;
    for (var i=0;i<arr.length;i++){
      if (isFinite(arr[i])){ s += arr[i]; c++; }
    }
    return c? (s/c) : NaN;
  }

  function stddev(arr){
    var m = mean(arr);
    if (!isFinite(m)) return NaN;
    var s=0, c=0;
    for (var i=0;i<arr.length;i++){
      if (isFinite(arr[i])){
        var d = arr[i]-m;
        s += d*d;
        c++;
      }
    }
    return c>1 ? Math.sqrt(s/(c-1)) : 0;
  }

  // Rhythm score from lap-to-lap variation: higher is steadier (0‚Äì100)
  function rhythmScore(cumSplitsMs){
    if (!cumSplitsMs || cumSplitsMs.length < 2){
      return {score: 0, note: 'Need more laps to score rhythm.', perLap: []};
    }
    var per = [];
    for (var i=0;i<cumSplitsMs.length;i++){
      var prev = i===0 ? 0 : cumSplitsMs[i-1];
      per.push(cumSplitsMs[i] - prev);
    }
    var m = mean(per);
    var sd = stddev(per);
    if (!isFinite(m) || m<=0) return {score: 0, note:'Not enough data.', perLap: per};
    var cv = sd / m; // lower is better

    var score = 100 * Math.exp(-6*cv);
    score = Math.round(clamp(score, 0, 100));

    var note =
      (score>=75) ? 'Very steady ‚Äî nice rhythm.' :
      (score>=55) ? 'Steady ‚Äî keep matching your steps + breathing.' :
      (score>=35) ? 'Getting there ‚Äî aim for smoother rhythm.' :
                   'Let‚Äôs practice ‚Äî focus on calm breathing + even steps.';

    return {score: score, note: note, perLap: per};
  }

  function trendTag(perLap){
    if (!perLap || perLap.length < 2) return {tag:'‚Äî', hint:'Need more laps for a trend.'};
    var mid = Math.floor(perLap.length/2);
    var a = mean(perLap.slice(0, mid));
    var b = mean(perLap.slice(mid));
    if (!isFinite(a) || !isFinite(b)) return {tag:'‚Äî', hint:'‚Äî'};
    var diff = (b - a) / a; // + = slower later
    if (diff <= -0.03) return {tag:'Strong finish', hint:'Later laps got faster.'};
    if (diff < 0.03)   return {tag:'Even pacing', hint:'Your pace stayed steady.'};
    return {tag:'Faded a bit', hint:'Later laps got slower ‚Äî try smoother rhythm.'};
  }

  function buildSpark(perLap){
    var W=600, H=78, pad=10;
    if (!perLap || !perLap.length){
      sparkPath.setAttribute('d','');
      sparkDot.setAttribute('cx','0');
      sparkDot.setAttribute('cy','0');
      return;
    }
    var min=Infinity, max=-Infinity;
    for (var i=0;i<perLap.length;i++){ min=Math.min(min, perLap[i]); max=Math.max(max, perLap[i]); }
    if (!isFinite(min) || !isFinite(max) || min===max){ min = min||0; max = min+1; }

    var dx = (W - pad*2) / Math.max(1, (perLap.length-1));
    var d = '';
    for (var j=0;j<perLap.length;j++){
      var x = pad + j*dx;
      var t = (perLap[j]-min)/(max-min);
      var y = pad + (1-t)*(H - pad*2);
      d += (j===0 ? 'M' : ' L') + x.toFixed(1) + ' ' + y.toFixed(1);
    }
    sparkPath.setAttribute('d', d);

    var lastX = pad + (perLap.length-1)*dx;
    var lastT = (perLap[perLap.length-1]-min)/(max-min);
    var lastY = pad + (1-lastT)*(H - pad*2);
    sparkDot.setAttribute('cx', lastX.toFixed(1));
    sparkDot.setAttribute('cy', lastY.toFixed(1));
  }

  function setFinishPills(finished){
    while (finishPills.firstChild) finishPills.removeChild(finishPills.firstChild);

    if (!finished){
      var p = document.createElement('span');
      p.className = 'pill bad';
      p.textContent = 'DNF (try again)';
      finishPills.appendChild(p);

      var q = document.createElement('span');
      q.className = 'pill';
      q.textContent = 'Goal: calm rhythm';
      finishPills.appendChild(q);
      return;
    }

    var p1 = document.createElement('span');
    p1.className = 'pill good';
    p1.textContent = 'Finish ‚úî';
    finishPills.appendChild(p1);

    var p2 = document.createElement('span');
    p2.className = 'pill';
    p2.textContent = 'Notice rhythm + feelings';
    finishPills.appendChild(p2);

    var p3 = document.createElement('span');
    p3.className = 'pill';
    p3.textContent = 'Encourage a partner';
    finishPills.appendChild(p3);
  }

  function setLeaderTable(rows, selectedId){
    while (leaderBody.firstChild) leaderBody.removeChild(leaderBody.firstChild);
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      var tr = document.createElement('tr');
      if (String(r.id) === String(selectedId)) tr.className = 'me';
      tr.innerHTML =
        '<td>'+r.id+'</td>' +
        '<td>'+ (isFinite(r.finishMs) ? msToMMSS(r.finishMs) : 'DNF') +'</td>' +
        '<td>'+ (isFinite(r.rhythm) ? (r.rhythm + '/100') : '‚Äî') +'</td>';
      leaderBody.appendChild(tr);
    }
  }

  function setGroupSnapshot(allRows){
    var total = allRows.length;
    var finished = 0;
    for (var i=0;i<allRows.length;i++){
      if (isFinite(allRows[i].finishMs)) finished++;
    }
    var pct = total ? Math.round((finished/total)*100) : 0;
    completionPct.textContent = pct + '%';
    completionBar.style.width = pct + '%';
    completionNote.textContent = finished + ' of ' + total + ' finished.';
  }

  function buildRunnerOptions(runners){
    while (runnerSel.firstChild) runnerSel.removeChild(runnerSel.firstChild);

    var opt0 = document.createElement('option');
    opt0.value = '__group__';
    opt0.textContent = 'Group (Everyone)';
    runnerSel.appendChild(opt0);

    for (var i=0;i<runners.length;i++){
      var opt = document.createElement('option');
      opt.value = String(runners[i].id);
      opt.textContent = 'Runner ' + runners[i].id;
      runnerSel.appendChild(opt);
    }
  }

  function applyMeta(data){
    var when = data.createdAt ? new Date(data.createdAt) : null;
    var whenStr = when && !isNaN(when.getTime()) ? when.toLocaleString() : '‚Äî';
    metaLine.textContent =
      (data.runDistanceMeters ? (data.runDistanceMeters + ' m') : 'Run') +
      ' ‚Ä¢ ' + (data.lapsConfig ? (data.lapsConfig + ' laps') : '') +
      ' ‚Ä¢ ' + whenStr;
  }

  function getRunnerFromQuery(){
    var params = new URLSearchParams(location.search);
    return params.get('runner');
  }
  function setQueryRunner(val){
    var params = new URLSearchParams(location.search);
    if (!val || val === '__group__') params.delete('runner');
    else params.set('runner', val);
    var newUrl = location.pathname + (params.toString() ? ('?' + params.toString()) : '');
    history.replaceState(null, '', newUrl);
  }

  function showGroupMode(data, selectedId){
    runnerTitle.textContent = 'Everyone';
    finishPill.textContent = 'Group';
    finishPill.className = 'pill';

    finishTimeEl.textContent = data.lapsConfig + ' laps';
    setFinishPills(true);

    rhythmScoreEl.textContent = 'Together';
    rhythmBar.style.width = '100%';
    rhythmNote.textContent = 'Today‚Äôs goal: match rhythm, support each other, and reflect.';

    trendHint.textContent = 'From ‚Äúonly time‚Äù ‚Üí to rhythm, effort, feelings.';
    sparkPath.setAttribute('d','');
    sparkDot.setAttribute('cx','0');
    sparkDot.setAttribute('cy','0');
    lapList.textContent = 'Try: ‚ÄúYou can do it!‚Äù ‚Ä¢ ‚ÄúLet‚Äôs match our rhythm!‚Äù';

    var rows = [];
    for (var i=0;i<data.runners.length;i++){
      var r = data.runners[i];
      var finishMs = r.splitsMs && r.splitsMs.length ? r.splitsMs[r.splitsMs.length-1] : NaN;
      var rsObj = rhythmScore(r.splitsMs || []);
      rows.push({ id:r.id, finishMs: finishMs, rhythm: rsObj.score });
    }
    rows.sort(function(a,b){
      var fa = a.finishMs, fb = b.finishMs;
      if (!isFinite(fa) && !isFinite(fb)) return Number(a.id)-Number(b.id);
      if (!isFinite(fa)) return 1;
      if (!isFinite(fb)) return -1;
      return fa - fb;
    });

    setGroupSnapshot(rows);
    setLeaderTable(rows, selectedId);
  }

  function showRunnerMode(data, runnerId){
    var r = null;
    for (var i=0;i<data.runners.length;i++){
      if (String(data.runners[i].id) === String(runnerId)){
        r = data.runners[i]; break;
      }
    }
    if (!r){ showGroupMode(data, runnerId); return; }

    runnerTitle.textContent = 'Runner ' + r.id;
    finishPill.textContent = r.finished ? 'Finished' : 'DNF';
    finishPill.className = 'pill ' + (r.finished ? 'good' : 'bad');

    var splits = r.splitsMs || [];
    var finishMs = splits.length ? splits[splits.length-1] : NaN;

    finishTimeEl.textContent = isFinite(finishMs) ? msToMMSS(finishMs) : 'DNF';
    setFinishPills(!!r.finished);

    var rs = rhythmScore(splits);
    rhythmScoreEl.textContent = rs.score + '/100';
    rhythmBar.style.width = rs.score + '%';
    rhythmNote.textContent = rs.note;

    var perLap = rs.perLap || [];
    var t = trendTag(perLap);
    trendHint.textContent = t.tag + ' ‚Ä¢ ' + t.hint;

    buildSpark(perLap);

    if (!perLap.length){
      lapList.textContent = 'No lap trend available.';
    } else {
      var out = [];
      for (var j=0;j<perLap.length;j++){
        out.push('Lap ' + (j+1) + ': ' + msToMMSS(perLap[j]));
      }
      lapList.textContent = out.join('  ‚Ä¢  ');
    }

    var rows = [];
    for (var k=0;k<data.runners.length;k++){
      var rr = data.runners[k];
      var fms = rr.splitsMs && rr.splitsMs.length ? rr.splitsMs[rr.splitsMs.length-1] : NaN;
      var rrScore = rhythmScore(rr.splitsMs || []).score;
      rows.push({ id: rr.id, finishMs: fms, rhythm: rrScore });
    }
    rows.sort(function(a,b){
      var fa = a.finishMs, fb = b.finishMs;
      if (!isFinite(fa) && !isFinite(fb)) return Number(a.id)-Number(b.id);
      if (!isFinite(fa)) return 1;
      if (!isFinite(fb)) return -1;
      return fa - fb;
    });

    setGroupSnapshot(rows);
    setLeaderTable(rows, r.id);
  }

  function readData(){
    var raw = localStorage.getItem(STORE_KEY);
    var data = safeParse(raw || '');
    if (!data || !data.runners || !Array.isArray(data.runners)){
      noData.style.display = 'block';
      app.style.display = 'none';
      metaLine.textContent = 'No data yet';
      return null;
    }
    return data;
  }

  function refresh(){
    var data = readData();
    if (!data) return;

    noData.style.display = 'none';
    app.style.display = 'grid';

    applyMeta(data);

    data.runners.sort(function(a,b){ return Number(a.id) - Number(b.id); });
    buildRunnerOptions(data.runners);

    var q = getRunnerFromQuery();
    if (q && q !== '__group__'){
      runnerSel.value = q;
      if (runnerSel.value !== q) runnerSel.value = '__group__';
    } else {
      runnerSel.value = '__group__';
    }

    if (runnerSel.value === '__group__') showGroupMode(data, q);
    else showRunnerMode(data, runnerSel.value);
  }

  runnerSel.addEventListener('change', function(){
    setQueryRunner(runnerSel.value);
    refresh();
  });

  shareBtn.addEventListener('click', async function(){
    try{
      await navigator.clipboard.writeText(location.href);
      shareBtn.textContent = 'Copied!';
      setTimeout(function(){ shareBtn.textContent = 'Copy Link'; }, 900);
    }catch(e){
      shareBtn.textContent = 'Copy failed';
      setTimeout(function(){ shareBtn.textContent = 'Copy Link'; }, 900);
    }
  });

  clearBtn.addEventListener('click', function(){
    localStorage.removeItem(STORE_KEY);
    refresh();
  });

  refresh();
})();
</script>
</body>
</html>
